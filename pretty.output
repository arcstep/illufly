@auth @register @api-doc
Feature: 用户认证系统 - 注册模块 # bdd/features/fastapi/auth/register.feature:2
  """
  用户认证系统 - 注册模块 API 文档
  基础路径: /api/auth
  版本: 0.7
  最后更新: 2024-12-15
  负责人: @xuehongwei
  - POST /auth/register: 用户注册
  - 参数 (Form):
  - username: str, 必填, 用户名
  - password: str, 必填, 密码
  - email: str, 必填, 电子邮箱
  - invite_code: str, 可选, 邀请码
  - 返回:
  - success: bool, 操作是否成功
  - user_info: dict, 用户信息
  - user_id: str, 用户ID
  - username: str, 用户名
  - email: str, 电子邮箱
  - roles: List[str], 用户角色
  - is_active: bool, 是否激活
  - created_at: datetime, 创建时间
  - Cookie:
  - access_token: JWT访问令牌
  - refresh_token: JWT刷新令牌
  - 错误码:
  - 400: 参数验证失败
  - 500: 服务器内部错误
  - 用户名:
  - 长度: 3-32个字符
  - 允许字符: 字母、数字、下划线
  - 不允许纯数字
  - 密码强度要求:
  - 最小长度: 8个字符
  - 必须包含: 大小写字母、数字、特殊字符
  - 不允许常见密码
  - 邮箱:
  - 标准邮箱格式
  - 域名必须有效
  - 邀请码:
  - 长度: 8-16个字符
  - 有效期: 24小时
  - 使用次数限制
  - 密码加密存储: Argon2id
  - 防重放攻击: 注册请求去重
  - 频率限制: 每IP每小时最多10次注册尝试
  - 敏感信息脱敏
  """
  Background: 测试环境准备  # bdd/features/fastapi/auth/register.feature:57

  @duplicate @error @wip
  Scenario: 注册重复用户名       # bdd/features/fastapi/auth/register.feature:107
    Given FastAPI 已经准备好   # bdd/features/steps/common.py:3
    And 清理测试数据            # bdd/features/steps/common.py:8
    Given 准备好用户表单         # bdd/features/steps/register_steps.py:7
      | 字段       | 值               |
      | username | duplicate_user  |
      | password | Test123!@#      |
      | email    | new@example.com |
    When 提交用户注册请求         # bdd/features/steps/register_steps.py:12
    Then 系统返回状态码 400      # bdd/features/steps/register_steps.py:44
      Traceback (most recent call last):
        File "/Users/xuehongwei/Library/Caches/pypoetry/virtualenvs/illufly-S5GgtCoU-py3.10/lib/python3.10/site-packages/behave/model.py", line 1329, in run
          match.run(runner.context)
        File "/Users/xuehongwei/Library/Caches/pypoetry/virtualenvs/illufly-S5GgtCoU-py3.10/lib/python3.10/site-packages/behave/matchers.py", line 98, in run
          self.func(context, *args, **kwargs)
        File "bdd/features/steps/register_steps.py", line 46, in step_impl
          assert context.response.status_code == status_code
      AssertionError
      
      Captured stdout:
      FastAPI 已经准备好
      清理测试数据
      准备注册表单数据: <Table: 2x3>
      >>> response_data {'success': True, 'user_info': {'user_id': '20241219-02894-0000-2460', 'username': 'duplicate_user', 'email': 'new@example.com', 'roles': ['guest', 'user'], 'created_at': '2024-12-19T18:08:14.533137', 'require_password_change': False, 'last_password_change': '2024-12-19T18:08:14.533144', 'password_expires_days': 90, 'last_login': None, 'failed_login_attempts': 0, 'last_failed_login': None, 'is_locked': False, 'is_active': True, 'verify_invite_code': None}}
      获取到用户ID: 20241219-02894-0000-2460
      
      Captured logging:
      INFO:httpx:HTTP Request: POST http://testserver/api/auth/register "HTTP/1.1 200 OK"

    And 返回错误信息包含 "用户名已存在" # None

