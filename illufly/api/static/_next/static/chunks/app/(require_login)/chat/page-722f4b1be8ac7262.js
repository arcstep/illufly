(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[508,792],{1226:()=>{},7181:(e,t,s)=>{Promise.resolve().then(s.bind(s,9804))},9804:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>I});var l=s(5155),n=s(2115),r=s(8435),a=s(9093),i=s(9757),o=s(5055);function c(e){let{onChangeAgent:t,selected_agent:s,setIsAgentListVisible:n,isAgentListVisible:r,setIsHistoryListVisible:a,isHistoryListVisible:c}=e;return(0,l.jsxs)("div",{className:"w-full md:w-1/6 p-4 border-b md:border-b-0 md:border-r flex flex-col",children:[(0,l.jsxs)("div",{className:"mt-12 flex ".concat(r?"flex-row":"flex-col"),children:[n&&(0,l.jsx)("button",{onClick:()=>n(!r),className:"mr-2 px-3 py-1 rounded-full transition-all duration-300 ".concat(r?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.UBk,style:{color:r?"white":"lightgray"}})}),a&&(0,l.jsx)("button",{onClick:()=>a(!c),className:"mr-2 px-3 py-1 rounded-full transition-all duration-300 ".concat(c?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.Int,style:{color:c?"white":"lightgray"}})})]}),(0,l.jsx)("ul",{className:"mt-4 flex-1 overflow-y-auto md:max-h-none max-h-64 min-h-32",children:[{id:"fake_llm",name:"模拟",icon:"\uD83E\uDD16"},{id:"chat",name:"聊天",icon:"\uD83D\uDCAC"},{id:"learn",name:"训练",icon:"\uD83E\uDDD1‍\uD83C\uDF93"}].map(e=>(0,l.jsxs)("li",{className:"cursor-pointer p-2 mb-2 flex items-center rounded-full transition-all duration-300 ".concat(s===e.id?"bg-blue-300 text-white shadow-md":"bg-gray-300 text-gray-800 hover:bg-gray-400"),onClick:()=>t(e.id),children:[(0,l.jsx)("span",{className:"mr-2",children:e.icon}),(0,l.jsx)("span",{children:e.name})]},e.id))})]})}function d(e){let{agents:t,onChangeAgent:s,selected_agent:n,toggleAgentList:r,toggleHistoryList:a,isAgentListVisible:c,isHistoryListVisible:d}=e;return(0,l.jsxs)("div",{className:"mt-12 flex flex-col items-center space-y-2",children:[(0,l.jsx)("button",{onClick:r,className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(c?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.UBk,style:{color:c?"white":"lightgray"}})}),(0,l.jsx)("button",{onClick:a,className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(d?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.Int,style:{color:d?"white":"lightgray"}})}),t.map(e=>(0,l.jsx)("div",{className:"cursor-pointer p-2 mb-2 flex items-center rounded-full transition-all duration-300 ".concat(n===e.id?"bg-blue-300 text-white shadow-md":"bg-gray-300 text-gray-800 hover:bg-gray-400"),onClick:()=>s(e.id),children:(0,l.jsx)("span",{className:"mr-2",children:e.icon})},e.id))]})}function u(e){var t;let{tabs:s,selectedTab:n,onSelectTab:r}=e;return(0,l.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,l.jsx)("ul",{className:"flex border-b-2 border-gray-200 bg-white sticky top-0 z-10",children:s.map(e=>(0,l.jsx)("li",{className:"cursor-pointer p-2 ".concat(n===e.key?"border-b-2 border-blue-500":""),onClick:()=>r(e.key),children:e.label},e.key))}),(0,l.jsx)("div",{className:"flex-1 overflow-y-auto h-full",children:null===(t=s.find(e=>e.key===n))||void 0===t?void 0:t.content})]})}function x(e){let{historyId:t,historyList:s,onSelectHistory:n,onNewHistory:r}=e;return Array.isArray(s)?(0,l.jsxs)("div",{className:"w-full max-w-xs p-4 border-b md:border-b-0 md:border-r flex flex-col h-full",children:[(0,l.jsx)("div",{className:"flex justify-center mb-4",children:(0,l.jsx)("button",{onClick:r,className:"w-full p-2 bg-gray-300 text-black rounded",children:"+ 新建对话"})}),(0,l.jsx)("div",{className:"flex-1 overflow-y-auto md:max-h-none max-h-64 min-h-32",children:s.map(e=>(0,l.jsx)("button",{onClick:()=>n(e),className:"p-2 rounded mb-1 ".concat(e===t?"bg-blue-500 text-white":"bg-gray-300 text-black"),children:e},e))})]}):(console.error("historyList is not an array"),null)}var h=s(8050),m=s(5012),g=s(4572);function f(e){let{content:t}=e,[s,r]=(0,n.useState)(!1),[a,i]=(0,n.useState)(""),[o,c]=(0,n.useState)(!1),d=JSON.parse(t),u=d.filter(e=>{var t;return(null===(t=e.meta)||void 0===t?void 0:t.distance)<1}),x=o?d.slice(0,3):u,f=e=>{i(e),r(!0)};return(0,l.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,l.jsx)("div",{className:"flex space-x-4 overflow-x-auto",children:x.map((e,t)=>{var s,n;return(0,l.jsxs)("div",{className:"bg-white p-4 rounded shadow-sm border border-gray-200",children:[(null===(s=e.meta)||void 0===s?void 0:s.source)&&(0,l.jsx)("div",{className:"text-sm font-semibold text-gray-800",children:e.meta.source}),e.text?(0,l.jsx)(h.A,{content:e.text.substring(0,100)+"...",className:"text-xs text-gray-600 mt-1"}):(0,l.jsx)("div",{className:"text-xs text-gray-600 mt-1",children:"没有可展示的内容"}),(0,l.jsxs)("div",{className:"flex items-center mt-2",children:[(null===(n=e.meta)||void 0===n?void 0:n.distance)!==void 0&&(0,l.jsx)("span",{className:"inline-block bg-yellow-100 text-yellow-800 rounded-full px-2 py-0.5",children:e.meta.distance.toFixed(2)}),(0,l.jsx)("button",{className:"ml-auto text-blue-500 text-sm",onClick:()=>f(e.text),children:"查看详情"}),(0,l.jsx)(g.A,{content:e.text})]})]},t)})}),(0,l.jsx)("button",{className:"text-blue-500 text-sm mt-2",onClick:()=>{c(!o)},children:o?"仅展示强相关检索结果":"展示全部".concat(d.length,"个检索结果")}),(0,l.jsx)(m.A,{isOpen:s,content:a,onClose:()=>{r(!1),i("")}})]})}function y(e){let{messages:t}=e,s=(0,n.useRef)(null),[r,a]=(0,n.useState)([]),[c,d]=(0,n.useState)({});(0,n.useEffect)(()=>{var e;null===(e=s.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[t]);let u=e=>{a(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},x=(e,t)=>{d(s=>{var l;return{...s,[e]:{...s[e],[t]:!(null===(l=s[e])||void 0===l?void 0:l[t])}}})};return(0,l.jsxs)("div",{className:"h-full flex flex-col bg-gray-50",children:[(0,l.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,l.jsxs)("ul",{children:[t.map(e=>{var t,s,n,a,d,m;return(0,l.jsxs)("li",{className:"flex items-start relative group mb-4 p-4 rounded-lg shadow-sm bg-white \n                                ".concat(r.includes(e.id)?"border-2 border-blue-500":"border border-gray-200"),children:[(0,l.jsxs)("div",{className:"flex flex-col items-center mr-4",children:[e.logo,(0,l.jsxs)("div",{className:"mt-2 flex flex-col items-center \n                                        ".concat(r.includes(e.id)||(null===(t=c[e.id])||void 0===t?void 0:t.star)||(null===(s=c[e.id])||void 0===s?void 0:s.like)||(null===(n=c[e.id])||void 0===n?void 0:n.dislike)?"opacity-100":"opacity-0 group-hover:opacity-100"," transition-opacity duration-300"),children:[(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full mb-2 flex items-center justify-center \n                                            ".concat(r.includes(e.id)?"bg-blue-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>u(e.id),title:"点击选择/取消选择",children:(0,l.jsx)(i.g,{icon:o.e68})}),(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full mb-2 flex items-center justify-center \n                                            ".concat((null===(a=c[e.id])||void 0===a?void 0:a.star)?"bg-yellow-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>x(e.id,"star"),title:"收藏",children:(0,l.jsx)(i.g,{icon:o.yy})}),"你"!==e.name&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full mb-2 flex items-center justify-center \n                                                    ".concat((null===(d=c[e.id])||void 0===d?void 0:d.like)?"bg-green-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>x(e.id,"like"),title:"点赞",children:(0,l.jsx)(i.g,{icon:o.Wcv})}),(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full flex items-center justify-center \n                                                    ".concat((null===(m=c[e.id])||void 0===m?void 0:m.dislike)?"bg-red-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>x(e.id,"dislike"),title:"踩",children:(0,l.jsx)(i.g,{icon:o.lS9})})]})]})]}),(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsx)("div",{className:"font-semibold text-gray-800",children:e.name}),e.segments.map((t,s)=>(0,l.jsxs)("div",{className:"bg-white p-2 mb-2 rounded",children:[(0,l.jsxs)("div",{className:"flex items-center text-xs text-gray-500 mb-1",children:[(0,l.jsx)("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5",children:t.type.toUpperCase()}),["human","chunk"].includes(t.type)&&(0,l.jsx)(g.A,{content:t.content}),(0,l.jsx)("span",{className:"text-gray-400 ml-auto",children:e.timestamp})]}),"rag"===t.type?(0,l.jsx)(f,{content:t.content}):(0,l.jsx)(h.A,{content:t.content,className:"text-sm text-gray-700 prose prose-sm max-w-none"})]},s))]})]},e.id)}),(0,l.jsx)("div",{ref:s})]})}),r.length>0&&(0,l.jsxs)("div",{className:"sticky bottom-0 bg-white p-2 shadow-md flex justify-between",children:[(0,l.jsx)("button",{className:"text-blue-500",onClick:()=>{console.log("分享消息:",t.filter(e=>r.includes(e.id)))},children:"分享选中的消息"}),(0,l.jsx)("button",{className:"text-red-500",onClick:()=>{a([])},children:"取消分享"})]})]})}function p(e){let{onSendMessage:t}=e,[s,r]=(0,n.useState)(""),[a,c]=(0,n.useState)([]),d=e=>{c(t=>t.filter(t=>t.name!==e))};return(0,l.jsx)("div",{className:"sticky bottom-0 bg-gray-100 p-4 shadow-inner",children:(0,l.jsxs)("div",{className:"flex flex-col bg-white p-3 rounded-lg shadow-md",children:[a.length>0&&(0,l.jsx)("div",{className:"flex flex-wrap mb-2",children:a.map((e,t)=>(0,l.jsxs)("div",{className:"flex items-center text-sm text-gray-600 mr-2 mb-1",children:[(0,l.jsx)("span",{className:"mr-1",children:e.name}),(0,l.jsx)("button",{className:"text-red-500 hover:text-red-600",onClick:()=>d(e.name),children:(0,l.jsx)(i.g,{icon:o.GRI})})]},t))}),(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsxs)("label",{className:"flex items-center cursor-pointer text-blue-500 hover:text-blue-600 mr-2",children:[(0,l.jsx)(i.g,{icon:o.WMI}),(0,l.jsx)("input",{type:"file",className:"hidden",multiple:!0,onChange:e=>{let t=Array.from(e.target.files);c(e=>[...e,...t])}})]}),(0,l.jsx)("textarea",{className:"flex-1 p-3 m-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out",rows:"1",style:{maxHeight:"10em",resize:"none",overflowY:"auto"},placeholder:"输入你的消息...",value:s,onChange:e=>r(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),s.trim()&&(t(s),r(""),e.target.style.height="auto"))},onInput:e=>{let t=e.target;t.style.height="auto",t.style.height="".concat(Math.min(t.scrollHeight,160),"px")}}),(0,l.jsx)("button",{className:"bg-blue-400 text-white px-4 py-2 ml-2 rounded-lg shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 transition duration-150 ease-in-out",onClick:e=>{s.trim()&&(t(s),r(""),e.target.previousSibling.style.height="auto")},children:"发送"})]})]})})}var b=s(6828),j=s(5370);let v=async()=>{try{await j.A.post("/api/auth/refresh-token",{},{withCredentials:!0})}catch(e){console.log("刷新令牌失败")}},w=async function(e,t,s){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},n=null;return await v(),(()=>{let r=new URL(b.J+e);l.params&&Object.keys(l.params).forEach(e=>r.searchParams.append(e,l.params[e])),(n=new EventSource(r,{withCredentials:!0})).onmessage=e=>{try{let s=JSON.parse(e.data);t(s.calling_id,s)}catch(e){console.error("JSON 解析错误:",e),s&&s(e)}},n.onerror=e=>{n.close()}})(),{stop:()=>{n&&n.close()}}},N=async(e,t,s,l)=>{await w("/api/".concat(e||"fake_llm"),s,l,{params:{prompt:t}})},k=async(e,t,s)=>{j.A.get("/api/".concat(e||"fake_llm","/history/list")).then(t).catch(s)},A=async(e,t,s,l)=>{let n=new FormData;n.append("history_id",t),j.A.post("/api/".concat(e||"fake_llm","/history/change"),n).then(s).catch(l)},_=async(e,t,s)=>{j.A.post("/api/".concat(e||"fake_llm","/history/new")).then(t).catch(s)},S=["text","chunk","tool_resp_text","tool_resp_chunk"],C=[];function L(e){let{agent:t,setAgent:s,isHistoryListVisible:r}=e,[a,c]=(0,n.useState)([]),[d,u]=(0,n.useState)(""),[h,m]=(0,n.useState)([]),g=(0,n.useRef)(h),f=(0,n.useRef)([]),b=(0,n.useRef)(null);(0,n.useEffect)(()=>{j(t)},[t]),(0,n.useEffect)(()=>{g.current=h},[h]);let j=async e=>{s(e),k(e,t=>{L(e,t.data.history_id),Array.isArray(t.data.history_list)?c(t.data.history_list):(console.error("获取的历史记录列表不是数组:",t.data),c([]))},e=>{console.log("获取历史记录列表失败:",e)})},v=async()=>{await _(t,e=>{c(t=>[e.data,...t]),u(e.data),m([])})},w=async e=>{L(t,e)},L=async(e,t)=>{u(t);try{await A(e,t,e=>{let t=[];for(let s in e.data.history){let n=e.data.history[s],r=null,a=null;n.forEach(e=>{let{block_type:t,content:n,content_id:c,created_at:d}=JSON.parse(e.data);if("human"===t)r||(r={id:"".concat(s,"-human"),sender:"user",logo:(0,l.jsx)(i.g,{icon:o.X46}),name:"你",segments:[{type:t,content:n}],timestamp:new Date(d).toLocaleString()});else if(a||(a={id:"".concat(s,"-ai"),sender:"ai",logo:(0,l.jsx)(i.g,{icon:o.UBk}),name:"AI",segments:[],timestamp:new Date(d).toLocaleString()}),S.includes(t)){let e=a.segments.find(e=>e.id===c);e?e.content+=n:a.segments.push({type:t,id:c,content:n})}else a.segments.push({type:t,id:c,content:n})}),r&&t.push(r),a&&t.push(a)}m(t)},e=>{console.error("获取历史记录失败:",e)})}catch(e){console.error("处理历史记录失败:",e)}},E=async e=>{try{let s={id:"user-".concat(Date.now()),sender:"user",logo:(0,l.jsx)(i.g,{icon:o.X46}),name:"你",segments:[{type:"human",content:e}],timestamp:new Date().toLocaleString()};m([...g.current,s]);let n="";await N(t,e,(e,t)=>{let{block_type:s,content_id:r,content:a}=t;!C.includes(s)&&(f.current.push(t=>{let c=[...t],d=c.length-1,u=c[d];if(u&&u.id===e){let e=u.segments.length-1,t=u.segments[e];if(S.includes(s)){t&&t.id===r?n+=a:n=a;let l={type:s,id:r,content:n},i=[...u.segments];t&&t.id===r?i[e]=l:i.push(l);let o={...u,segments:i};c[d]=o}else{let e=[...u.segments,{type:s,id:r,content:a}],t={...u,segments:e};c[d]=t}}else c.push({id:e,sender:"ai",logo:(0,l.jsx)(i.g,{icon:o.UBk}),name:"AI",segments:[{type:s,id:r,content:a}],timestamp:new Date().toLocaleString()});return c}),b.current||(b.current=setInterval(()=>{if(f.current.length>0){let e=g.current;f.current.forEach(t=>{e=t(e)}),f.current=[],m(e)}else clearInterval(b.current),b.current=null},300)))},e=>{console.error("SSE 错误:",e)})}catch(e){console.error("发送消息失败:",e)}};return(0,l.jsxs)("div",{className:"flex flex-1 flex-col md:flex-row h-full",children:[r&&(0,l.jsx)("div",{className:"w-full md:w-1/4 h-full flex flex-col",children:(0,l.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,l.jsx)(x,{historyId:d,historyList:a,onSelectHistory:w,onNewHistory:v})})}),(0,l.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,l.jsx)("div",{className:"flex-1 overflow-y-auto p-4 h-full",children:(0,l.jsx)(y,{messages:h})}),(0,l.jsx)(p,{onSendMessage:E})]})]})}function E(e){let{agent:t,setAgent:s}=e;return(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto min-h-[150px] p-4",children:[(0,l.jsx)("h2",{children:"模型配置"}),(0,l.jsx)("form",{children:(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{children:(0,l.jsx)("label",{children:"智能体名称"})}),(0,l.jsx)("p",{children:(0,l.jsx)("label",{children:"从清单中选择模型"})}),(0,l.jsx)("p",{children:(0,l.jsx)("label",{children:"模型参数：温度、最大token数、种子等"})}),(0,l.jsx)("input",{type:"text",value:t,onChange:e=>s(e.target.value)})]})})]})}function I(){let{user:e,logout:t,fetchUser:s,refreshToken:i}=(0,r.A)(),[o,x]=(0,n.useState)(!0),[h,m]=(0,n.useState)(!1),[g,f]=(0,n.useState)("fake_llm"),[y,p]=(0,n.useState)("chat");return e?(0,l.jsxs)("div",{className:"p-5 pt-12 h-screen flex flex-col",children:[(0,l.jsx)(a.A,{username:e.username,onLogout:t,onFetchUser:s,onRefreshToken:i,currentPath:"/chat"}),(0,l.jsxs)("div",{className:"flex flex-1 flex-col md:flex-row h-full",children:[o?(0,l.jsx)(c,{onChangeAgent:f,selected_agent:g,setIsAgentListVisible:x,isAgentListVisible:o,setIsHistoryListVisible:m,isHistoryListVisible:h}):(0,l.jsx)(d,{agents:[{id:"fake_llm",name:"模拟",icon:"\uD83E\uDD16"},{id:"chat",name:"聊天",icon:"\uD83D\uDCAC"},{id:"learn",name:"训练",icon:"\uD83E\uDDD1‍\uD83C\uDF93"}],onChangeAgent:f,selected_agent:g,toggleAgentList:()=>x(!o),toggleHistoryList:()=>m(!h),isAgentListVisible:o,isHistoryListVisible:h}),(0,l.jsx)("div",{className:"flex-1 flex flex-col overflow-y-auto h-full",children:(0,l.jsx)(u,{tabs:[{key:"chat",label:"对话",content:(0,l.jsx)("div",{className:"flex-1 overflow-y-auto h-full",children:(0,l.jsx)(L,{agent:g,setAgent:f,isHistoryListVisible:h})})},{key:"settings",label:"配置",content:(0,l.jsx)("div",{className:"flex-1 overflow-y-auto h-full",children:(0,l.jsx)(E,{agent:g,setAgent:f})})}],selectedTab:y,onSelectTab:p})})]})]}):null}},4572:(e,t,s)=>{"use strict";s.d(t,{A:()=>i});var l=s(5155),n=s(2115),r=s(9757),a=s(5055);function i(e){let{content:t,getContent:s}=e,[i,o]=(0,n.useState)({show:!1,position:{x:0,y:0}}),[c,d]=(0,n.useState)(!1),u=async e=>{let l=t;if("function"==typeof s&&!t){d(!0);try{l=await s()}catch(e){console.error("获取复制内容失败:",e);return}finally{d(!1)}}navigator.clipboard.writeText(l).then(()=>{o({show:!0,position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>o({show:!1,position:{x:0,y:0}}),500)}).catch(e=>{console.error("复制失败:",e)})};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{className:"ml-2 text-gray-400 hover:text-gray-600 focus:text-gray-800 transition-colors duration-200",onClick:u,title:"复制内容",disabled:c,children:(0,l.jsx)(r.g,{icon:c?a.z1G:a.jPR,className:c?"animate-spin":""})}),i.show&&(0,l.jsx)("div",{className:"absolute bg-green-500 text-white px-2 py-1 rounded shadow-lg",style:{top:i.position.y-30,left:i.position.x,zIndex:200},children:"复制成功"})]})}},9093:(e,t,s)=>{"use strict";s.d(t,{A:()=>i});var l=s(5155),n=s(7396),r=s(2115);function a(e){let{username:t,onLogout:s,onFetchUser:n,onRefreshToken:a}=e,[i,o]=(0,r.useState)(!1),c=(0,r.useRef)(null),d="未登录";return t&&(d=t.length>10?"".concat(t.slice(0,10),"..."):t),(0,r.useEffect)(()=>{let e=e=>{c.current&&!c.current.contains(e.target)&&o(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,l.jsxs)("div",{className:"relative",ref:c,children:[(0,l.jsx)("button",{onClick:()=>o(!i),className:"bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600",title:t,children:d}),i&&(0,l.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-50",children:[(0,l.jsx)("button",{onClick:n,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"魔法师信息"}),(0,l.jsx)("button",{onClick:a,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"更新魔法令牌"}),(0,l.jsx)("hr",{className:"border-gray-600"}),(0,l.jsx)("button",{onClick:s,className:"w-full text-left px-4 py-2 text-red-500 hover:bg-gray-700",children:"离开梦幻岛"})]})]})}function i(e){let{username:t,onLogout:s,onFetchUser:r,onRefreshToken:i,currentPath:o}=e;return(0,l.jsxs)("header",{className:"flex justify-between items-center fixed top-0 left-0 right-0 z-50 bg-gray-800 text-white p-2",children:[(0,l.jsx)("h1",{className:"text-xl md:text-2xl font-bold",children:"✨\uD83E\uDD8B 梦幻岛"}),(0,l.jsx)("div",{className:"flex space-x-4",children:["/publish","/chat","/knowledge","/agent"].map(e=>(0,l.jsx)(n.default,{href:e,children:(0,l.jsxs)("span",{className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(o===e?"bg-gradient-to-r from-blue-400 to-purple-400 text-white shadow-md":"bg-transparent text-gray-200 hover:bg-gray-600"),children:["/publish"===e&&"传说","/knowledge"===e&&"秘典","/agent"===e&&"精灵","/chat"===e&&"魔语"]})},e))}),(0,l.jsx)("div",{className:"flex items-center",children:(0,l.jsx)(a,{username:t,onLogout:s,onFetchUser:r,onRefreshToken:i})})]})}},5012:(e,t,s)=>{"use strict";s.d(t,{A:()=>a});var l=s(5155),n=s(2115),r=s(8050);function a(e){var t,s;let{isOpen:a,knowledge:i,get_knowledge:o,onClose:c}=e,[d,u]=(0,n.useState)(null),[x,h]=(0,n.useState)(!1),[m,g]=(0,n.useState)(null);return((0,n.useEffect)(()=>{(async()=>{if(a&&(null==i?void 0:i.id)&&!d){h(!0),g(null);try{let e=await o(i.id);u(e)}catch(e){console.error("加载数据失败:",e),g("加载失败，请重试")}finally{h(!1)}}})()},[a,null==i?void 0:i.id]),a)?(0,l.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&c()},children:(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-xl mx-4 my-6 w-full max-w-6xl h-[90vh] flex flex-col",children:[(0,l.jsx)("div",{className:"px-6 py-4 border-b",children:(0,l.jsxs)("div",{className:"flex justify-between items-start",children:[(0,l.jsx)("div",{className:"flex-1",children:(0,l.jsxs)("div",{className:"flex flex-col gap-2",children:[(null==i?void 0:null===(t=i.tags)||void 0===t?void 0:t.length)>0&&(0,l.jsx)("div",{className:"flex flex-wrap gap-2",children:i.tags.map((e,t)=>(0,l.jsx)("span",{className:"px-2 py-0.5 text-xs bg-blue-50 text-blue-600 rounded-full",children:e},t))}),(0,l.jsxs)("div",{className:"text-sm text-gray-500",children:[(0,l.jsxs)("div",{children:["ID: ",null==i?void 0:i.id]}),(null==i?void 0:i.source)&&(0,l.jsxs)("div",{children:["来源: ",i.source]})]})]})}),(0,l.jsx)("button",{className:"text-gray-500 hover:text-gray-700 transition-colors ml-4",onClick:c,children:(0,l.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),(0,l.jsx)("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:m?(0,l.jsx)("div",{className:"text-center text-red-500",children:m}):x?(0,l.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,l.jsx)("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"})}):(null==d?void 0:null===(s=d.content)||void 0===s?void 0:s.text)?(0,l.jsx)("div",{className:"prose prose-lg max-w-none",children:(0,l.jsx)(r.A,{content:d.content.text})}):(0,l.jsx)("div",{className:"text-center text-gray-500",children:"暂无内容"})}),(0,l.jsx)("div",{className:"px-6 py-3 border-t bg-gray-50",children:(0,l.jsx)("div",{className:"text-sm text-gray-500",children:(null==d?void 0:d.raw_meta)&&(0,l.jsxs)("details",{className:"mt-2",children:[(0,l.jsx)("summary",{className:"cursor-pointer hover:text-gray-700",children:"原始元数据"}),(0,l.jsx)("pre",{className:"mt-2 p-2 bg-gray-100 rounded text-xs overflow-x-auto",children:JSON.stringify(d.raw_meta,null,2)})]})})})]})}):null}},8050:(e,t,s)=>{"use strict";s.d(t,{A:()=>g});var l=s(5155);s(2115);var n=s(7564),r=s(7558),a=s(9054),i=s(7802),o=s(6731),c=s(7076),d=s(1883),u=s(8629),x=s(3273),h=s(4920);let m={...x.j,tagNames:[...x.j.tagNames,"question","final_answer","no_final_answer","context","knowledge","OUTLINE"],attributes:{...x.j.attributes,question:["className"],final_answer:["className"],no_final_answer:["className"],context:["className"],knowledge:["className"],OUTLINE:["className"]}};function g(e){let{content:t,className:s=""}=e,x=e=>{let{tagName:t,...s}=e;return(0,l.jsxs)("div",{className:"relative border border-blue-300 p-4 my-4 rounded-md bg-blue-50",children:[(0,l.jsx)("span",{className:"absolute top-0 left-2 bg-white px-2 text-xs text-blue-500 border border-blue-300 rounded -mt-2.5",children:t}),(0,l.jsx)("div",{...s})]})};return(0,l.jsx)("div",{className:"prose prose-sm max-w-none ".concat(s," bg-gray-100 p-2 rounded-lg shadow-md"),children:(0,l.jsx)(n.o,{remarkPlugins:[r.A,a.A,c.A,d.A],rehypePlugins:[u.A,(0,h.A)(m),i.A,o.A],components:{question:e=>(0,l.jsx)(x,{tagName:"question",...e}),final_answer:e=>(0,l.jsx)(x,{tagName:"final_answer",...e}),no_final_answer:e=>(0,l.jsx)(x,{tagName:"no_final_answer",...e}),context:e=>(0,l.jsx)(x,{tagName:"context",...e}),knowledge:e=>(0,l.jsx)(x,{tagName:"knowledge",...e}),OUTLINE:e=>(0,l.jsx)(x,{tagName:"OUTLINE",...e}),h1:e=>{let{node:t,...s}=e;return(0,l.jsx)("h1",{className:"text-3xl font-bold my-4",...s})},h2:e=>{let{node:t,...s}=e;return(0,l.jsx)("h2",{className:"text-2xl font-semibold my-3",...s})},p:e=>{let{node:t,...s}=e;return(0,l.jsx)("p",{className:"text-base leading-relaxed my-2",...s})},pre:e=>{let{node:t,...s}=e;return(0,l.jsx)("pre",{className:"bg-gray-800 text-white p-4 rounded-md my-4 overflow-x-auto",...s})}},children:t||""})})}},8435:(e,t,s)=>{"use strict";s.d(t,{A:()=>c,AuthProvider:()=>o});var l=s(5155),n=s(2115),r=s(6046),a=s(6828);let i=(0,n.createContext)({user_id:null,username:null,email:null,role:null,device_id:null,isAuthenticated:!1,login:async()=>{throw Error("AuthProvider not found")},logout:async()=>{throw Error("AuthProvider not found")},refresh_token:async()=>{throw Error("AuthProvider not found")}});function o(e){let{children:t}=e,s=(0,r.useRouter)(),o=(0,r.useSearchParams)(),c=(0,r.usePathname)(),d=["/login","/register","/forgot-password"],[u,x]=(0,n.useState)(null),[h,m]=(0,n.useState)(null),[g,f]=(0,n.useState)(null),[y,p]=(0,n.useState)(null),[b,j]=(0,n.useState)(null),[v,w]=(0,n.useState)(!1);(0,n.useEffect)(()=>{d.includes(c)||N()},[c]);let N=async()=>{let e=await fetch("".concat(a.J,"/auth/profile"),{credentials:"include"});if(e.ok){let t=await e.json();console.log(t),x(t.user_id),m(t.device_id),f(t.username),p(t.email),j(t.role),w(!0)}else s.push("/login")},k=async(e,t)=>{console.log("login >>> ",e,t);let l=await fetch("".concat(a.J,"/auth/login"),{method:"POST",credentials:"include",headers:{accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});if(!l.ok)throw Error((await l.json()).detail||"Login failed");let n=await l.json();x(n.user_id),m(n.device_id),f(n.username),p(n.email),j(n.role),w(!0);let r=o.get("from")||"/";s.replace(r)},A=async()=>{await fetch("".concat(a.J,"/auth/logout"),{method:"POST",credentials:"include"}),x(null),f(null),p(null),j(null),w(!1),s.replace("/login")};return(0,l.jsx)(i.Provider,{value:{user_id:u,device_id:h,username:g,email:y,role:b,isAuthenticated:v,login:k,logout:A,refresh_token:N},children:t})}function c(){let e=(0,n.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},5370:(e,t,s)=>{"use strict";s.d(t,{A:()=>a});var l=s(2651),n=s(6828);let r=l.A.create({baseURL:n.J,withCredentials:!0});r.interceptors.response.use(e=>e,async e=>{let t=e.config;if(e.response&&401===e.response.status&&!t._retry){t._retry=!0;try{return await r.post("/api/auth/refresh-token",{},{withCredentials:!0}),r(t)}catch(e){return(0,n.t)(e),Promise.reject(e)}}return e.response&&403===e.response.status&&console.error("访问被拒绝:",e),(0,n.t)(e),Promise.reject(e)});let a=r},6828:(e,t,s)=>{"use strict";s.d(t,{J:()=>n,t:()=>r});var l=s(5521);let n=s(2818).env.NEXT_PUBLIC_API_BASE_URL||"/api",r=e=>{e.response&&401===e.response.status?console.log("未授权，重定向到登录页"):console.log("API 请求错误:",e),l.default.push("/login")}}},e=>{var t=t=>e(e.s=t);e.O(0,[779,420,804,19,622,694,432,592,331,271,30,519,408,473,376,358],()=>t(7181)),_N_E=e.O()}]);