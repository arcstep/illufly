(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[792,846],{41226:()=>{},52487:(e,t,s)=>{Promise.resolve().then(s.bind(s,84893))},84893:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>g});var n=s(95155),r=s(12115),l=s(67396),a=s(82651),o=s(86828);let c=a.A.create({baseURL:o.J,withCredentials:!0});c.interceptors.response.use(e=>e,async e=>{let t=e.config;if(e.response&&401===e.response.status&&!t._retry){t._retry=!0;try{return await c.post("/api/auth/refresh-token",{},{withCredentials:!0}),c(t)}catch(e){return(0,o.t)(e),Promise.reject(e)}}return e.response&&403===e.response.status&&console.error("访问被拒绝:",e),(0,o.t)(e),Promise.reject(e)});let i=async e=>{try{return(await c.get("/api/knowledge/".concat(e))).data}catch(t){throw console.error("获取知识[".concat(e,"]失败:"),t),t}},u=async(e,t)=>{let{content:s=null,tags:n=null,summary:r=null,source:l=null}=t,a=new FormData;null!==s&&a.append("content",s),null!==n&&a.append("tags",n.join(",")),null!==r&&a.append("summary",r),null!==l&&a.append("source",l);try{return(await c.put("/api/knowledge/".concat(e),a)).data}catch(t){throw console.error("更新知识[".concat(e,"]失败:"),t),t}};var d=s(68435);s(59093);var m=s(18050);function x(e){let{onClick:t,isContentChanged:s=!0}=e,[l,a]=(0,r.useState)({show:!1,type:"success",position:{x:0,y:0}}),[o,c]=(0,r.useState)(s);(0,r.useEffect)(()=>{s&&c(!0)},[s]);let i=async e=>{try{await (null==t?void 0:t(e)),a({show:!0,type:"success",position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>{a({show:!1,type:"success",position:{x:0,y:0}}),setTimeout(()=>c(!1),200)},1500)}catch(t){a({show:!0,type:"error",position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>a({show:!1,type:"error",position:{x:0,y:0}}),1500)}};return o?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("button",{className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors",onClick:i,children:[(0,n.jsx)("svg",{className:"w-4 h-4 mr-1.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),"保存"]}),l.show&&(0,n.jsx)("div",{className:"absolute text-white px-2 py-1 rounded shadow-lg ".concat("success"===l.type?"bg-green-500":"bg-red-500"),style:{top:l.position.y-30,left:l.position.x,zIndex:200},children:"success"===l.type?"保存成功":"保存失败"})]}):null}function h(e){let{tags:t=[],onChange:s}=e,[l,a]=(0,r.useState)(""),o=(0,r.useRef)(null),c=e=>{s(t.filter((t,s)=>s!==e))};return(0,n.jsxs)("div",{className:"flex items-center flex-wrap gap-2",children:[t.map((e,t)=>(0,n.jsxs)("span",{className:"px-2 py-0.5 bg-blue-50 text-blue-600 rounded-full text-xs flex items-center group",children:[e,(0,n.jsx)("button",{onClick:()=>c(t),className:"ml-1 text-blue-400 hover:text-blue-600",children:"\xd7"})]},t)),(0,n.jsx)("input",{ref:o,type:"text",value:l,onChange:e=>a(e.target.value),onKeyDown:e=>{"Enter"===e.key&&l.trim()?(e.preventDefault(),t.includes(l.trim())||s([...t,l.trim()]),a("")):"Backspace"===e.key&&!l&&t.length>0&&s(t.slice(0,-1))},className:"outline-none border-none bg-transparent text-sm min-w-20 flex-grow",placeholder:0===t.length?"输入标签后按回车添加":""})]})}function g(){let{isAuthenticated:e,changeCurrentPath:t}=(0,d.A)(),[s,a]=(0,r.useState)(!0),[o,c]=(0,r.useState)(null),[g,p]=(0,r.useState)(""),[f,y]=(0,r.useState)(null),w=(0,r.useRef)(null),[j,b]=(0,r.useState)(!1),[v,N]=(0,r.useState)(""),[k,S]=(0,r.useState)([]),[A,_]=(0,r.useState)(!1),[C,E]=(0,r.useState)(""),[P,L]=(0,r.useState)(""),[T,O]=(0,r.useState)(!1),I=(0,r.useRef)(null),[D,H]=(0,r.useState)(null);(0,r.useEffect)(()=>{t("/knowledge");{let{searchParams:e}=new URL(window.location.href),t=e.get("knowledge_id");y(t),J(t)}},[fetchUser]);let J=async e=>{if(e){a(!0);try{let t=await i(e);if(null==t?void 0:t.content){let e=t.content.text,s=t.content.meta.summary||"",n=t.content.meta.tags||[];c(t),p(e),N(e),E(s),L(s),S(n),b(!1),O(!1),_(!1)}}catch(e){console.error("Error loading knowledge content:",e)}finally{a(!1)}}},U=e=>{if(w.current){let t=e.scrollTop/(e.scrollHeight-e.clientHeight),s=w.current.scrollHeight-w.current.clientHeight;w.current.scrollTop=t*s}},R=e=>{if(I.current){let t=e.scrollTop/(e.scrollHeight-e.clientHeight),s=I.current.scrollHeight-I.current.clientHeight;I.current.scrollTop=t*s}},z=async()=>{if(!f)throw console.error("Knowledge ID is not set"),Error("Knowledge ID is not set");try{return await u(f,{content:j?g:null,tags:A?k:null,summary:T?C:null}),N(g),L(C),b(!1),O(!1),_(!1),await J(f),!0}catch(e){throw console.error("知识更新失败:",e),e}};return e?(0,n.jsx)("main",{className:"container mx-auto px-4 py-6 max-w-7xl",children:(0,n.jsxs)("div",{className:"flex-1 flex flex-col p-4 overflow-hidden",children:[(0,n.jsx)("div",{className:"bg-white rounded-lg shadow-sm p-4 mb-4",children:(0,n.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,n.jsx)("div",{className:"flex justify-between items-center",children:(0,n.jsxs)("div",{className:"flex items-center space-x-6",children:[(0,n.jsxs)(l.default,{href:"/knowledge",className:"flex items-center text-blue-600 hover:text-blue-700 transition-colors",children:[(0,n.jsx)("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"返回"]}),(0,n.jsxs)("div",{className:"flex items-center space-x-2 text-gray-600",children:[(0,n.jsx)("span",{className:"font-medium",children:"文档ID:"}),(0,n.jsx)("code",{className:"px-2 py-1 bg-gray-100 rounded text-sm",children:f})]})]})}),(0,n.jsxs)("div",{className:"flex items-center space-x-2 px-2",children:[(0,n.jsx)("span",{className:"font-medium text-gray-600",children:"标签:"}),(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsx)(h,{tags:k,onChange:e=>{var t,s;let n=(null==o?void 0:null===(s=o.content)||void 0===s?void 0:null===(t=s.meta)||void 0===t?void 0:t.tags)||[],r=JSON.stringify(e)!==JSON.stringify(n);S(e),_(r)}})}),(0,n.jsx)(x,{onClick:z,isContentChanged:j||A||T})]})]})}),!s&&(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"bg-white rounded-xl shadow-sm",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-100",children:[(0,n.jsx)("h2",{className:"text-sm font-medium text-gray-700",children:"文档摘要"}),(0,n.jsx)("button",{onClick:()=>H("summary"===D?null:"summary"),className:"text-sm px-3 py-1 rounded-md transition-colors ".concat("summary"===D?"bg-blue-50 text-blue-600":"text-gray-500 hover:bg-gray-50"),children:"summary"===D?"完成编辑":"编辑摘要"})]}),(0,n.jsx)("div",{className:"p-4",children:"summary"===D?(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,n.jsx)("div",{ref:I,className:"prose prose-sm max-w-none",children:(0,n.jsx)(m.A,{content:C})}),(0,n.jsx)("div",{className:"flex flex-col",children:(0,n.jsx)("textarea",{className:"w-full h-[200px] p-4 border rounded-lg resize-none  font-mono text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500",value:C,onChange:e=>{let t=e.target.value;E(t),O(t!==P),R(e.target)},onScroll:e=>R(e.target),placeholder:"在此输入文档摘要..."})})]}):(0,n.jsx)("div",{className:"prose prose-sm max-w-none",children:(0,n.jsx)(m.A,{content:C})})})]}),(0,n.jsxs)("div",{className:"bg-white rounded-xl shadow-sm",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-100",children:[(0,n.jsx)("h2",{className:"text-sm font-medium text-gray-700",children:"正文内容"}),(0,n.jsx)("button",{onClick:()=>H("content"===D?null:"content"),className:"text-sm px-3 py-1 rounded-md transition-colors ".concat("content"===D?"bg-blue-50 text-blue-600":"text-gray-500 hover:bg-gray-50"),children:"content"===D?"完成编辑":"编辑正文"})]}),(0,n.jsx)("div",{className:"p-4",children:"content"===D?(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,n.jsx)("div",{ref:w,className:"prose prose-sm max-w-none",children:(0,n.jsx)(m.A,{content:g})}),(0,n.jsx)("div",{className:"flex flex-col",children:(0,n.jsx)("textarea",{className:"w-full h-[500px] p-4 border rounded-lg resize-none  font-mono text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500",value:g,onChange:e=>{let t=e.target.value;p(t),b(t!==v),U(e.target)},onScroll:e=>U(e.target),placeholder:"在此输入正文内容..."})})]}):(0,n.jsx)("div",{className:"prose prose-sm max-w-none",children:(0,n.jsx)(m.A,{content:g})})})]})]})]})}):(0,n.jsx)("div",{children:"Loading..."})}},59093:(e,t,s)=>{"use strict";s.d(t,{A:()=>o});var n=s(95155),r=s(67396),l=s(12115);function a(e){let{username:t,onLogout:s}=e,[r,a]=(0,l.useState)(!1),[o,c]=(0,l.useState)(""),i=(0,l.useRef)(null);return(0,l.useEffect)(()=>{t?c(t.length>10?"".concat(t.slice(0,10),"..."):t):c("未登录")},[t]),(0,l.useEffect)(()=>{let e=e=>{i.current&&!i.current.contains(e.target)&&a(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,n.jsxs)("div",{className:"relative",ref:i,children:[(0,n.jsx)("button",{onClick:()=>a(!r),className:"bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600",title:t,children:o}),r&&(0,n.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-50",children:[(0,n.jsx)("hr",{className:"border-gray-600"}),(0,n.jsx)("button",{onClick:s,className:"w-full text-left px-4 py-2 text-red-500 hover:bg-gray-700",children:"退出"})]})]})}function o(e){let{username:t,onLogout:s,currentPath:l}=e;return(0,n.jsxs)("header",{className:"flex justify-between items-center fixed top-0 left-0 right-0 z-50 bg-gray-800 text-white p-2",children:[(0,n.jsx)("h1",{className:"text-xl md:text-2xl font-bold",children:"✨\uD83E\uDD8B ILLUFLY"}),(0,n.jsx)("div",{className:"flex space-x-4",children:["/chat","/memory","/apikeys"].map(e=>(0,n.jsx)(r.default,{href:e,children:(0,n.jsxs)("span",{className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(l===e?"bg-gradient-to-r from-blue-400 to-purple-400 text-white shadow-md":"bg-transparent text-gray-200 hover:bg-gray-600"),children:["/chat"===e&&"对话","/memory"===e&&"记忆","/apikeys"===e&&"模型接口"]})},e))}),(0,n.jsx)("div",{className:"flex items-center",children:(0,n.jsx)(a,{username:t,onLogout:s})})]})}},18050:(e,t,s)=>{"use strict";s.d(t,{A:()=>g});var n=s(95155);s(12115);var r=s(87564),l=s(77558),a=s(69054),o=s(27802),c=s(26731),i=s(77076),u=s(44264),d=s(38629),m=s(43273),x=s(24920);let h={...m.j,tagNames:[...m.j.tagNames,"question","final_answer","no_final_answer","context","knowledge","OUTLINE"],attributes:{...m.j.attributes,question:["className"],final_answer:["className"],no_final_answer:["className"],context:["className"],knowledge:["className"],OUTLINE:["className"]}};function g(e){let{content:t,className:s=""}=e,m=e=>{let{tagName:t,...s}=e;return(0,n.jsxs)("div",{className:"relative border border-blue-300 p-4 my-4 rounded-md bg-blue-50",children:[(0,n.jsx)("span",{className:"absolute top-0 left-2 bg-white px-2 text-xs text-blue-500 border border-blue-300 rounded -mt-2.5",children:t}),(0,n.jsx)("div",{...s})]})};return(0,n.jsx)("div",{className:"prose prose-sm max-w-none ".concat(s," bg-gray-100 p-2 rounded-lg shadow-md"),children:(0,n.jsx)(r.o,{remarkPlugins:[l.A,a.A,i.A,u.A],rehypePlugins:[d.A,(0,x.A)(h),o.A,c.A],components:{question:e=>(0,n.jsx)(m,{tagName:"question",...e}),final_answer:e=>(0,n.jsx)(m,{tagName:"final_answer",...e}),no_final_answer:e=>(0,n.jsx)(m,{tagName:"no_final_answer",...e}),context:e=>(0,n.jsx)(m,{tagName:"context",...e}),knowledge:e=>(0,n.jsx)(m,{tagName:"knowledge",...e}),OUTLINE:e=>(0,n.jsx)(m,{tagName:"OUTLINE",...e}),h1:e=>{let{node:t,...s}=e;return(0,n.jsx)("h1",{className:"text-3xl font-bold my-4",...s})},h2:e=>{let{node:t,...s}=e;return(0,n.jsx)("h2",{className:"text-2xl font-semibold my-3",...s})},p:e=>{let{node:t,...s}=e;return(0,n.jsx)("p",{className:"text-base leading-relaxed my-2",...s})},pre:e=>{let{node:t,...s}=e;return(0,n.jsx)("pre",{className:"bg-gray-800 text-white p-4 rounded-md my-4 overflow-x-auto",...s})}},children:t||""})})}},68435:(e,t,s)=>{"use strict";s.d(t,{A:()=>i,AuthProvider:()=>c});var n=s(95155),r=s(12115),l=s(76046),a=s(86828);let o=(0,r.createContext)({user_id:null,username:null,email:null,role:null,device_id:null,isAuthenticated:!1,currentPath:null,login:async()=>{throw Error("AuthProvider not found")},logout:async()=>{throw Error("AuthProvider not found")},refresh_token:async()=>{throw Error("AuthProvider not found")},changeCurrentPath:async()=>{throw Error("AuthProvider not found")}});function c(e){let{children:t}=e,s=(0,l.useRouter)(),c=(0,l.useSearchParams)(),i=(0,l.usePathname)(),[u,d]=(0,r.useState)(!0),m=["/login","/register","/forgot-password"],[x,h]=(0,r.useState)(null),[g,p]=(0,r.useState)(null),[f,y]=(0,r.useState)(null),[w,j]=(0,r.useState)(null),[b,v]=(0,r.useState)(null),[N,k]=(0,r.useState)(!1),[S,A]=(0,r.useState)(null);(0,r.useEffect)(()=>{if(m.includes(i)){d(!1);return}_()},[i]);let _=async()=>{let e="".concat(a.J,"/auth/profile");console.log("api_url >>> ",e);try{console.log("开始刷新 token"),d(!0);let t=await fetch(e,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","Cache-Control":"no-cache",Pragma:"no-cache"},credentials:"include",signal:AbortSignal.timeout(8e3)});if(t.ok){let e=await t.json();h(e.user_id),p(e.device_id),y(e.username),j(e.email),v(e.role),k(!0)}else console.log("响应不成功，重定向到登录页"),k(!1),s.replace("/login")}catch(t){console.error("刷新 token 详细错误:",{error:t,message:t instanceof Error?t.message:"未知错误",api_url:e}),k(!1),s.replace("/login")}finally{d(!1)}},C=async(e,t)=>{console.log("login >>> ",e,t);let n=await fetch("".concat(a.J,"/auth/login"),{method:"POST",credentials:"include",headers:{accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});if(!n.ok)throw Error((await n.json()).detail||"Login failed");let r=await n.json();console.log("POST auth/login >>> ",r),h(r.user_id),p(r.device_id),y(r.username),j(r.email),v(r.role),k(!0);let l=c.get("from")||"/chat";s.replace(l)},E=async()=>{await fetch("".concat(a.J,"/auth/logout"),{method:"POST",credentials:"include"}),h(null),y(null),j(null),v(null),k(!1),s.replace("/login")},P=async e=>{A(e)};return u&&!m.includes(i)?(0,n.jsx)("div",{children:"Loading..."}):(0,n.jsx)(o.Provider,{value:{user_id:x,device_id:g,username:f,email:w,role:b,isAuthenticated:N,login:C,logout:E,refresh_token:_,currentPath:S,changeCurrentPath:P},children:t})}function i(){let e=(0,r.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},86828:(e,t,s)=>{"use strict";s.d(t,{J:()=>r,t:()=>l});var n=s(85521);let r="/api",l=e=>{e.response&&401===e.response.status?console.log("未授权，重定向到登录页"):console.log("API 请求错误:",e),n.default.push("/login")}}},e=>{var t=t=>e(e.s=t);e.O(0,[779,299,563,420,804,256,19,694,269,889,432,592,331,271,30,173,473,376,358],()=>t(52487)),_N_E=e.O()}]);