(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[792,898],{1226:()=>{},3633:(e,t,o)=>{Promise.resolve().then(o.bind(o,2727))},2727:(e,t,o)=>{"use strict";o.r(t),o.d(t,{default:()=>a});var l=o(5155),n=o(2115),r=o(8435);function a(){let{isAuthenticated:e,changeCurrentPath:t}=(0,r.A)();return((0,n.useEffect)(()=>{t("/favorite")},[]),e)?(0,l.jsx)("div",{className:"p-5 h-screen flex flex-col",children:(0,l.jsx)("div",{className:"flex-1 overflow-y-auto min-h-[150px] p-4"})}):(0,l.jsx)("div",{children:"Loading..."})}},8435:(e,t,o)=>{"use strict";o.d(t,{A:()=>u,AuthProvider:()=>i});var l=o(5155),n=o(2115),r=o(6046),a=o(6828);let s=(0,n.createContext)({user_id:null,username:null,email:null,role:null,device_id:null,isAuthenticated:!1,currentPath:null,login:async()=>{throw Error("AuthProvider not found")},logout:async()=>{throw Error("AuthProvider not found")},refresh_token:async()=>{throw Error("AuthProvider not found")},changeCurrentPath:async()=>{throw Error("AuthProvider not found")}});function i(e){let{children:t}=e,o=(0,r.useRouter)(),i=(0,r.useSearchParams)(),u=(0,r.usePathname)(),[c,d]=(0,n.useState)(!0),h=["/login","/register","/forgot-password"],[f,g]=(0,n.useState)(null),[p,v]=(0,n.useState)(null),[m,w]=(0,n.useState)(null),[P,y]=(0,n.useState)(null),[S,_]=(0,n.useState)(null),[A,E]=(0,n.useState)(!1),[j,x]=(0,n.useState)(null);(0,n.useEffect)(()=>{h.includes(u)?d(!1):k()},[u]);let k=async()=>{let e="".concat(a.J,"/auth/profile");console.log("api_url >>> ",e);try{console.log("开始刷新 token"),d(!0);let t=await fetch(e,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},credentials:"include",signal:AbortSignal.timeout(5e3)});if(console.log("获取到响应:",t.status),t.ok){let e=await t.json();g(e.user_id),v(e.device_id),w(e.username),y(e.email),_(e.role),E(!0)}else console.log("响应不成功，重定向到登录页"),E(!1),o.replace("/login")}catch(t){console.error("刷新 token 详细错误:",{error:t,message:t instanceof Error?t.message:"未知错误",api_url:e}),E(!1),o.replace("/login")}finally{d(!1)}},C=async(e,t)=>{console.log("login >>> ",e,t);let l=await fetch("".concat(a.J,"/auth/login"),{method:"POST",credentials:"include",headers:{accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});if(!l.ok)throw Error((await l.json()).detail||"Login failed");let n=await l.json();console.log("POST auth/login >>> ",n),g(n.user_id),v(n.device_id),w(n.username),y(n.email),_(n.role),E(!0);let r=i.get("from")||"/chat";o.replace(r)},b=async()=>{await fetch("".concat(a.J,"/auth/logout"),{method:"POST",credentials:"include"}),g(null),w(null),y(null),_(null),E(!1),o.replace("/login")},N=async e=>{x(e)};return c&&!h.includes(u)?(0,l.jsx)("div",{children:"Loading..."}):(0,l.jsx)(s.Provider,{value:{user_id:f,device_id:p,username:m,email:P,role:S,isAuthenticated:A,login:C,logout:b,refresh_token:k,currentPath:j,changeCurrentPath:N},children:t})}function u(){let e=(0,n.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},6828:(e,t,o)=>{"use strict";o.d(t,{J:()=>n,t:()=>r});var l=o(5521);let n="http://localhost:8000/api",r=e=>{e.response&&401===e.response.status?console.log("未授权，重定向到登录页"):console.log("API 请求错误:",e),l.default.push("/login")}}},e=>{var t=t=>e(e.s=t);e.O(0,[779,299,563,420,804,256,19,694,269,889,432,592,331,271,30,173,473,376,358],()=>t(3633)),_N_E=e.O()}]);