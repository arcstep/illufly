(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[508,792],{1226:()=>{},4615:(e,t,s)=>{Promise.resolve().then(s.bind(s,4938))},4938:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>v});var a=s(5155),l=s(2115),r=s(6828),n=s(9329);let o=(0,l.createContext)({currentThreadId:null,threads:[],lastChunks:[],messages:[],createNewThread:async()=>{throw Error("ChatProvider not found")},loadAllThreads:async()=>{throw Error("ChatProvider not found")},ask:async()=>{throw Error("ChatProvider not found")},toggleFavorite:async()=>{throw Error("ChatProvider not found")},switchThread:async()=>{throw Error("ChatProvider not found")}});function i(e){let{children:t}=e,[s,i]=(0,l.useState)(null),[c,d]=(0,l.useState)([]),[u,h]=(0,l.useState)([]),[x,m]=(0,l.useState)([]),g=e=>{let t=new Map;return e.forEach(e=>{var s;t.has(e.message_id)||t.set(e.message_id,[]),null===(s=t.get(e.message_id))||void 0===s||s.push(e)}),Array.from(t.values()).map(e=>{let t=e[0];if(1===e.length)return t;let s=e[0].created_at,a=e[e.length-1].completed_at;return{...t,content:e.map(e=>e.content).join(""),message_type:"text",created_at:s,completed_at:a}})},f=(0,l.useMemo)(()=>{if(!s&&0===u.length)return[];let e=[...x,...g(u)].sort((e,t)=>e.created_at-t.created_at);return console.log("合并后的消息:",e),e},[x,u,s]),p=async()=>{let e=await fetch("".concat(r.J,"/chat/threads"),{method:"POST",credentials:"include"}),t=await e.json();return i(t.thread_id),d([...c,t]),t.thread_id},y=async e=>{if(c.map(e=>e.thread_id).includes(e)){i(e);let t=await fetch("".concat(r.J,"/chat/threads/").concat(e,"/messages"),{credentials:"include"}),s=await t.json();console.log("加载远程对话消息数据",s),m(s)}},v=async()=>{try{let e=await fetch("".concat(r.J,"/chat/threads"),{credentials:"include"}),t=await e.json();d(t),console.log("收到的线程数据:",t)}catch(e){throw console.error("加载线程失败:",e),e}},j=async e=>{if(!s)return;let t=new AbortController,a=null,l=()=>{if(u.length>0){let e=g(u);console.log("合并消息:",e),m(t=>[...t,...e]),h([])}};try{await (0,n.y)("".concat(r.J,"/chat/threads/").concat(s,"/ask"),{method:"POST",credentials:"include",headers:{accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:e}]}),signal:t.signal,onopen:async e=>{if(200!==e.status||!e.ok)throw Error("请求失败: ".concat(e.status));if(!e.body)throw Error("没有响应体")},onmessage(e){try{let t=JSON.parse(e.data);"text_chunk"===t.message_type?(a&&a!==t.message_id&&l(),a=t.message_id,h(e=>[...e,t]),console.log("收到text_chunk消息:",t)):(l(),"end"===t.message_type?console.log("收到结束消息"):(m(e=>[...e,t]),console.log("收到其他类型消息:",t)))}catch(e){console.error("解析消息失败:",e)}},onclose(){console.log("SSE 连接已关闭"),l(),console.log("收到消息结束",c)},onerror(e){throw console.error("SSE 错误:",e),e}})}catch(e){throw console.error("发送消息失败:",e),e}finally{t.abort()}},w=async e=>{(await fetch("".concat(r.J,"/chat/messages/").concat(e,"/favorite"),{method:"POST",credentials:"include"})).ok};return(0,a.jsx)(o.Provider,{value:{currentThreadId:s,threads:c,lastChunks:u,messages:f,createNewThread:p,switchThread:y,loadAllThreads:v,ask:j,toggleFavorite:w},children:t})}function c(){let e=(0,l.useContext)(o);if(void 0===e)throw Error("useChat must be used within a ChatProvider");return e}function d(){let{threads:e,loadAllThreads:t,switchThread:s}=c(),[r,n]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{(async()=>{n(!0);try{await t(),console.log("更新 threads: ",e)}catch(e){console.error("加载历史记录失败:",e)}finally{n(!1)}})()},[]),(0,a.jsx)("div",{className:"w-full max-w-xs p-4 border-b md:border-b-0 md:border-r",children:r?(0,a.jsx)("div",{children:"加载中..."}):e.map(e=>{let{thread_id:t,title:l}=e;return(0,a.jsx)("button",{onClick:()=>s(t),className:"w-full p-2 text-left hover:bg-gray-100",children:(0,a.jsx)("div",{className:"font-medium",children:l})},t)})})}var u=s(9757),h=s(5055),x=s(8050);s(5012);var m=s(4572);function g(){let{threads:e,switchThread:t,currentThreadId:s,messages:r}=c(),n=(0,l.useRef)(null),[o,i]=(0,l.useState)([]),[d,g]=(0,l.useState)({});(0,l.useEffect)(()=>{let s=e.sort((e,t)=>t.created_at-e.created_at)[0];s&&t(s.thread_id)},[e]),(0,l.useEffect)(()=>{var e;console.log("messages: ",r),null===(e=n.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[r]);let f=e=>{i(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])};return(0,a.jsxs)("div",{className:"h-full flex flex-col bg-gray-50",children:[(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,a.jsxs)("ul",{className:"space-y-4",children:[r.map(e=>(0,a.jsxs)("li",{className:"flex gap-3 group relative p-4 rounded-lg shadow-sm bg-white \n                                ".concat(o.includes(e.message_id)?"border-2 border-blue-500":"border border-gray-200"),children:[(0,a.jsx)("div",{className:"w-8 flex-shrink-0",children:(0,a.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full flex items-center justify-center \n                                        ".concat(o.includes(e.message_id)?"bg-blue-500 text-white":"bg-gray-200 text-gray-400 opacity-0 group-hover:opacity-100"," \n                                        transition-opacity duration-200"),onClick:()=>f(e.message_id),title:"选择消息",children:(0,a.jsx)(u.g,{icon:h.e68,className:"text-sm"})})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsx)("span",{className:"font-medium text-gray-700",children:e.role}),(0,a.jsx)("span",{className:"inline-block bg-blue-100 text-blue-800 text-xs rounded-full px-2 py-0.5",children:e.message_type.toUpperCase()}),e.favorite&&(0,a.jsx)("span",{className:"text-yellow-500",children:(0,a.jsx)(u.g,{icon:h.yy,className:"text-sm"})}),(0,a.jsx)(m.A,{content:e.content}),(0,a.jsx)("span",{className:"text-xs text-gray-400 ml-auto",children:new Date(e.completed_at).toLocaleString()})]}),(0,a.jsx)("div",{className:"text-gray-800",children:(0,a.jsx)(x.A,{content:e.content,className:"prose prose-sm max-w-none"})})]})]},e.message_id)),(0,a.jsx)("div",{ref:n})]})}),o.length>0&&(0,a.jsxs)("div",{className:"sticky bottom-0 bg-white p-3 shadow-md flex justify-end gap-4",children:[(0,a.jsx)("button",{className:"px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700",onClick:()=>{console.log("分享消息:",r.filter(e=>o.includes(e.id)))},children:"分享选中消息"}),(0,a.jsx)("button",{className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-700",onClick:()=>{i([])},children:"取消选择"})]})]})}function f(){let{ask:e}=c(),[t,s]=(0,l.useState)(""),[r,n]=(0,l.useState)([]),o=e=>{n(t=>t.filter(t=>t.name!==e))};return(0,a.jsx)("div",{className:"sticky bottom-0 bg-gray-100 p-4 shadow-inner",children:(0,a.jsxs)("div",{className:"flex flex-col bg-white p-3 rounded-lg shadow-md",children:[r.length>0&&(0,a.jsx)("div",{className:"flex flex-wrap mb-2",children:r.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center text-sm text-gray-600 mr-2 mb-1",children:[(0,a.jsx)("span",{className:"mr-1",children:e.name}),(0,a.jsx)("button",{className:"text-red-500 hover:text-red-600",onClick:()=>o(e.name),children:(0,a.jsx)(u.g,{icon:h.GRI})})]},t))}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsxs)("label",{className:"flex items-center cursor-pointer text-blue-500 hover:text-blue-600 mr-2",children:[(0,a.jsx)(u.g,{icon:h.WMI}),(0,a.jsx)("input",{type:"file",className:"hidden",multiple:!0,onChange:e=>{let t=Array.from(e.target.files);n(e=>[...e,...t])}})]}),(0,a.jsx)("textarea",{className:"flex-1 p-3 m-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out",rows:"1",style:{maxHeight:"10em",resize:"none",overflowY:"auto"},placeholder:"输入你的消息...",value:t,onChange:e=>s(e.target.value),onKeyDown:a=>{"Enter"===a.key&&!a.shiftKey&&(a.preventDefault(),t.trim()&&(e(t),s(""),a.target.style.height="auto"))},onInput:e=>{let t=e.target;t.style.height="auto",t.style.height="".concat(Math.min(t.scrollHeight,160),"px")}}),(0,a.jsx)("button",{className:"bg-blue-400 text-white px-4 py-2 ml-2 rounded-lg shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 transition duration-150 ease-in-out",onClick:e=>{t.trim()&&(onSendMessage(t),s(""),e.target.previousSibling.style.height="auto")},children:"发送"})]})]})})}var p=s(8435);function y(){let{isAuthenticated:e,changeCurrentPath:t}=(0,p.A)(),[s]=(0,l.useState)(!0);return((0,l.useEffect)(()=>{t("/chat")},[]),e)?(0,a.jsxs)("div",{className:"flex flex-1 flex-col md:flex-row h-full",children:[s&&(0,a.jsx)("div",{className:"w-full md:w-1/4 h-full flex flex-col",children:(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,a.jsx)(d,{})})}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-4 h-full",children:(0,a.jsx)(g,{})}),(0,a.jsx)(f,{})]})]}):(0,a.jsx)("div",{children:"Loading..."})}function v(){return(0,a.jsx)(l.Suspense,{fallback:(0,a.jsx)("div",{children:"Chat Loading..."}),children:(0,a.jsx)(i,{children:(0,a.jsx)(y,{})})})}},4572:(e,t,s)=>{"use strict";s.d(t,{A:()=>o});var a=s(5155),l=s(2115),r=s(9757),n=s(5055);function o(e){let{content:t,getContent:s}=e,[o,i]=(0,l.useState)({show:!1,position:{x:0,y:0}}),[c,d]=(0,l.useState)(!1),u=async e=>{let a=t;if("function"==typeof s&&!t){d(!0);try{a=await s()}catch(e){console.error("获取复制内容失败:",e);return}finally{d(!1)}}navigator.clipboard.writeText(a).then(()=>{i({show:!0,position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>i({show:!1,position:{x:0,y:0}}),500)}).catch(e=>{console.error("复制失败:",e)})};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"ml-2 text-gray-400 hover:text-gray-600 focus:text-gray-800 transition-colors duration-200",onClick:u,title:"复制内容",disabled:c,children:(0,a.jsx)(r.g,{icon:c?n.z1G:n.jPR,className:c?"animate-spin":""})}),o.show&&(0,a.jsx)("div",{className:"absolute bg-green-500 text-white px-2 py-1 rounded shadow-lg",style:{top:o.position.y-30,left:o.position.x,zIndex:200},children:"复制成功"})]})}},5012:(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var a=s(5155),l=s(2115),r=s(8050);function n(e){var t,s;let{isOpen:n,knowledge:o,get_knowledge:i,onClose:c}=e,[d,u]=(0,l.useState)(null),[h,x]=(0,l.useState)(!1),[m,g]=(0,l.useState)(null);return((0,l.useEffect)(()=>{(async()=>{if(n&&(null==o?void 0:o.id)&&!d){x(!0),g(null);try{let e=await i(o.id);u(e)}catch(e){console.error("加载数据失败:",e),g("加载失败，请重试")}finally{x(!1)}}})()},[n,null==o?void 0:o.id]),n)?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&c()},children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl mx-4 my-6 w-full max-w-6xl h-[90vh] flex flex-col",children:[(0,a.jsx)("div",{className:"px-6 py-4 border-b",children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[(null==o?void 0:null===(t=o.tags)||void 0===t?void 0:t.length)>0&&(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:o.tags.map((e,t)=>(0,a.jsx)("span",{className:"px-2 py-0.5 text-xs bg-blue-50 text-blue-600 rounded-full",children:e},t))}),(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:[(0,a.jsxs)("div",{children:["ID: ",null==o?void 0:o.id]}),(null==o?void 0:o.source)&&(0,a.jsxs)("div",{children:["来源: ",o.source]})]})]})}),(0,a.jsx)("button",{className:"text-gray-500 hover:text-gray-700 transition-colors ml-4",onClick:c,children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:m?(0,a.jsx)("div",{className:"text-center text-red-500",children:m}):h?(0,a.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,a.jsx)("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"})}):(null==d?void 0:null===(s=d.content)||void 0===s?void 0:s.text)?(0,a.jsx)("div",{className:"prose prose-lg max-w-none",children:(0,a.jsx)(r.A,{content:d.content.text})}):(0,a.jsx)("div",{className:"text-center text-gray-500",children:"暂无内容"})}),(0,a.jsx)("div",{className:"px-6 py-3 border-t bg-gray-50",children:(0,a.jsx)("div",{className:"text-sm text-gray-500",children:(null==d?void 0:d.raw_meta)&&(0,a.jsxs)("details",{className:"mt-2",children:[(0,a.jsx)("summary",{className:"cursor-pointer hover:text-gray-700",children:"原始元数据"}),(0,a.jsx)("pre",{className:"mt-2 p-2 bg-gray-100 rounded text-xs overflow-x-auto",children:JSON.stringify(d.raw_meta,null,2)})]})})})]})}):null}},8050:(e,t,s)=>{"use strict";s.d(t,{A:()=>g});var a=s(5155);s(2115);var l=s(7564),r=s(7558),n=s(9054),o=s(7802),i=s(6731),c=s(7076),d=s(1883),u=s(8629),h=s(3273),x=s(4920);let m={...h.j,tagNames:[...h.j.tagNames,"question","final_answer","no_final_answer","context","knowledge","OUTLINE"],attributes:{...h.j.attributes,question:["className"],final_answer:["className"],no_final_answer:["className"],context:["className"],knowledge:["className"],OUTLINE:["className"]}};function g(e){let{content:t,className:s=""}=e,h=e=>{let{tagName:t,...s}=e;return(0,a.jsxs)("div",{className:"relative border border-blue-300 p-4 my-4 rounded-md bg-blue-50",children:[(0,a.jsx)("span",{className:"absolute top-0 left-2 bg-white px-2 text-xs text-blue-500 border border-blue-300 rounded -mt-2.5",children:t}),(0,a.jsx)("div",{...s})]})};return(0,a.jsx)("div",{className:"prose prose-sm max-w-none ".concat(s," bg-gray-100 p-2 rounded-lg shadow-md"),children:(0,a.jsx)(l.o,{remarkPlugins:[r.A,n.A,c.A,d.A],rehypePlugins:[u.A,(0,x.A)(m),o.A,i.A],components:{question:e=>(0,a.jsx)(h,{tagName:"question",...e}),final_answer:e=>(0,a.jsx)(h,{tagName:"final_answer",...e}),no_final_answer:e=>(0,a.jsx)(h,{tagName:"no_final_answer",...e}),context:e=>(0,a.jsx)(h,{tagName:"context",...e}),knowledge:e=>(0,a.jsx)(h,{tagName:"knowledge",...e}),OUTLINE:e=>(0,a.jsx)(h,{tagName:"OUTLINE",...e}),h1:e=>{let{node:t,...s}=e;return(0,a.jsx)("h1",{className:"text-3xl font-bold my-4",...s})},h2:e=>{let{node:t,...s}=e;return(0,a.jsx)("h2",{className:"text-2xl font-semibold my-3",...s})},p:e=>{let{node:t,...s}=e;return(0,a.jsx)("p",{className:"text-base leading-relaxed my-2",...s})},pre:e=>{let{node:t,...s}=e;return(0,a.jsx)("pre",{className:"bg-gray-800 text-white p-4 rounded-md my-4 overflow-x-auto",...s})}},children:t||""})})}},8435:(e,t,s)=>{"use strict";s.d(t,{A:()=>c,AuthProvider:()=>i});var a=s(5155),l=s(2115),r=s(6046),n=s(6828);let o=(0,l.createContext)({user_id:null,username:null,email:null,role:null,device_id:null,isAuthenticated:!1,currentPath:null,login:async()=>{throw Error("AuthProvider not found")},logout:async()=>{throw Error("AuthProvider not found")},refresh_token:async()=>{throw Error("AuthProvider not found")},changeCurrentPath:async()=>{throw Error("AuthProvider not found")}});function i(e){let{children:t}=e,s=(0,r.useRouter)(),i=(0,r.useSearchParams)(),c=(0,r.usePathname)(),[d,u]=(0,l.useState)(!0),h=["/login","/register","/forgot-password"],[x,m]=(0,l.useState)(null),[g,f]=(0,l.useState)(null),[p,y]=(0,l.useState)(null),[v,j]=(0,l.useState)(null),[w,b]=(0,l.useState)(null),[N,_]=(0,l.useState)(!1),[S,k]=(0,l.useState)(null);(0,l.useEffect)(()=>{h.includes(c)?u(!1):C()},[c]);let C=async()=>{let e="".concat(n.J,"/auth/profile");console.log("api_url >>> ",e);try{console.log("开始刷新 token"),u(!0);let t=await fetch(e,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},credentials:"include",signal:AbortSignal.timeout(5e3)});if(console.log("获取到响应:",t.status),t.ok){let e=await t.json();m(e.user_id),f(e.device_id),y(e.username),j(e.email),b(e.role),_(!0)}else console.log("响应不成功，重定向到登录页"),_(!1),s.replace("/login")}catch(t){console.error("刷新 token 详细错误:",{error:t,message:t instanceof Error?t.message:"未知错误",api_url:e}),_(!1),s.replace("/login")}finally{u(!1)}},E=async(e,t)=>{console.log("login >>> ",e,t);let a=await fetch("".concat(n.J,"/auth/login"),{method:"POST",credentials:"include",headers:{accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});if(!a.ok)throw Error((await a.json()).detail||"Login failed");let l=await a.json();console.log("POST auth/login >>> ",l),m(l.user_id),f(l.device_id),y(l.username),j(l.email),b(l.role),_(!0);let r=i.get("from")||"/chat";s.replace(r)},A=async()=>{await fetch("".concat(n.J,"/auth/logout"),{method:"POST",credentials:"include"}),m(null),y(null),j(null),b(null),_(!1),s.replace("/login")},P=async e=>{k(e)};return d&&!h.includes(c)?(0,a.jsx)("div",{children:"Loading..."}):(0,a.jsx)(o.Provider,{value:{user_id:x,device_id:g,username:p,email:v,role:w,isAuthenticated:N,login:E,logout:A,refresh_token:C,currentPath:S,changeCurrentPath:P},children:t})}function c(){let e=(0,l.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},6828:(e,t,s)=>{"use strict";s.d(t,{J:()=>l,t:()=>r});var a=s(5521);let l="http://localhost:8000/api",r=e=>{e.response&&401===e.response.status?console.log("未授权，重定向到登录页"):console.log("API 请求错误:",e),a.default.push("/login")}}},e=>{var t=t=>e(e.s=t);e.O(0,[779,299,563,420,804,256,19,694,269,889,432,592,331,271,30,173,473,376,358],()=>t(4615)),_N_E=e.O()}]);