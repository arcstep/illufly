(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[49,792],{1226:()=>{},1892:(e,t,s)=>{Promise.resolve().then(s.bind(s,8253))},8253:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>g});var a=s(5155),r=s(2115),l=s(3201),n=s(5731),o=s(518),i=s(7396),c=s(8050),d=s(4572),u=s(5012);let x=function(e){let{knowledge:t}=e,[s,l]=(0,r.useState)(!1);return t?(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 p-4",children:[(0,a.jsx)("div",{className:"mb-3",children:(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 line-clamp-2",children:(0,a.jsx)(c.A,{content:t.summary})})}),t.tags&&t.tags.length>0&&(0,a.jsx)("div",{className:"flex flex-wrap gap-1.5 mb-3",children:t.tags.map((e,t)=>(0,a.jsx)("span",{className:"px-2 py-0.5 text-xs bg-blue-50 text-blue-600 rounded-full",children:e},t))}),t.source&&(0,a.jsxs)("div",{className:"text-xs text-gray-500 mb-3",children:["来源: ",t.source]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-auto pt-2 border-t border-gray-100",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>l(!0),className:"text-sm text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1",children:"查看详情"}),(0,a.jsx)(d.A,{getContent:async()=>{var e;let s=await (0,o.oX)(t.id);return(null==s?void 0:null===(e=s.content)||void 0===e?void 0:e.text)||""}})]}),(0,a.jsx)(i.default,{href:"/knowledge/edit?knowledge_id=".concat(t.id),className:"text-sm text-blue-600 hover:text-blue-700 transition-colors",children:"编辑"})]}),(0,a.jsx)(u.A,{isOpen:s,knowledge:t,get_knowledge:o.oX,onClose:()=>l(!1)})]}):null};function g(){let{user:e,logout:t,fetchUser:s,refreshToken:i}=(0,l.A)(),[c,d]=(0,r.useState)({knowledgeList:[],knowledgeContents:{},loading:!0,error:null,pagination:{total:0,totalPages:1,currentPage:1},filters:{tags:[],matchAllTags:!0}}),[u]=(0,r.useState)(10);(0,r.useEffect)(()=>{x()},[c.pagination.currentPage]);let x=async()=>{d(e=>({...e,loading:!0,error:null}));try{let e={page:c.pagination.currentPage,pageSize:u,sortBy:"id",reverse:!1,tags:c.filters.tags.length>0?c.filters.tags:null,matchAllTags:c.filters.matchAllTags},t=await (0,o.zH)(e);d(e=>{var s,a,r;return{...e,knowledgeList:t.items,pagination:{total:t.total||0,totalPages:t.total_pages||1,currentPage:t.current_page||1},filters:{tags:(null===(s=t.filters)||void 0===s?void 0:s.tags)||[],matchAllTags:null===(r=null===(a=t.filters)||void 0===a?void 0:a.match_all_tags)||void 0===r||r}}})}catch(e){console.error("加载知识列表失败:",e),d(t=>({...t,error:e.message||"加载知识列表失败"}))}finally{d(e=>({...e,loading:!1}))}};return e?(0,a.jsxs)("div",{className:"p-5 pt-12 h-screen flex flex-col",children:[(0,a.jsx)(n.A,{username:e.username,onLogout:t,onFetchUser:s,onRefreshToken:i,currentPath:"/knowledge"}),(0,a.jsx)("div",{className:"px-4 py-2",children:(0,a.jsx)(y,{selectedTags:c.filters.tags,matchAllTags:c.filters.matchAllTags,onFilter:function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];d(s=>({...s,filters:{tags:e,matchAllTags:t},pagination:{...s.pagination,currentPage:1}}))}})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto min-h-[150px] p-4",children:c.error?(0,a.jsx)(m,{error:c.error,onRetry:x}):c.loading?(0,a.jsx)(h,{}):(0,a.jsx)(p,{knowledgeList:c.knowledgeList,knowledgeContents:c.knowledgeContents,pagination:c.pagination,onPageChange:e=>{d(t=>({...t,pagination:{...t.pagination,currentPage:e}}))}})})]}):null}let h=()=>(0,a.jsx)("div",{className:"flex justify-center items-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}),m=e=>{let{error:t,onRetry:s}=e;return(0,a.jsxs)("div",{className:"flex flex-col items-center py-8",children:[(0,a.jsx)("div",{className:"text-red-500 mb-4",children:t}),(0,a.jsx)("button",{onClick:s,className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",children:"重试"})]})},p=e=>{let{knowledgeList:t,knowledgeContents:s,pagination:r,onPageChange:l}=e;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.map(e=>(0,a.jsx)(x,{knowledge:e},e.id))}),r.totalPages>1&&(0,a.jsx)(f,{currentPage:r.currentPage,totalPages:r.totalPages,onPageChange:l})]})},f=e=>{let{currentPage:t,totalPages:s,onPageChange:r}=e;return(0,a.jsx)("div",{className:"mt-4 flex justify-center",children:Array.from({length:s},(e,s)=>(0,a.jsx)("button",{onClick:()=>r(s+1),className:"mx-1 px-3 py-1 rounded transition-colors ".concat(t===s+1?"bg-blue-500 text-white":"bg-gray-200 hover:bg-gray-300"),children:s+1},s+1))})},y=e=>{let{selectedTags:t,matchAllTags:s,onFilter:l}=e,[n,o]=(0,r.useState)(t),[i,c]=(0,r.useState)(s),d=e=>{let t=n.includes(e)?n.filter(t=>t!==e):[...n,e];o(t),l(t,i)};return(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("div",{className:"flex items-center mb-2",children:(0,a.jsxs)("label",{className:"flex items-center text-sm text-gray-600 mr-4",children:[(0,a.jsx)("input",{type:"checkbox",checked:i,onChange:e=>{let t=e.target.checked;c(t),l(n,t)},className:"mr-2"}),"匹配所有标签"]})}),(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:["chat_learn","ChatQwen"].map(e=>(0,a.jsx)("button",{onClick:()=>d(e),className:"px-3 py-1 rounded-full text-sm transition-colors ".concat(n.includes(e)?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:e},e))})]})}},4572:(e,t,s)=>{"use strict";s.d(t,{A:()=>o});var a=s(5155),r=s(2115),l=s(9757),n=s(5055);function o(e){let{content:t,getContent:s}=e,[o,i]=(0,r.useState)({show:!1,position:{x:0,y:0}}),[c,d]=(0,r.useState)(!1),u=async e=>{let a=t;if("function"==typeof s&&!t){d(!0);try{a=await s()}catch(e){console.error("获取复制内容失败:",e);return}finally{d(!1)}}navigator.clipboard.writeText(a).then(()=>{i({show:!0,position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>i({show:!1,position:{x:0,y:0}}),500)}).catch(e=>{console.error("复制失败:",e)})};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"ml-2 text-gray-400 hover:text-gray-600 focus:text-gray-800 transition-colors duration-200",onClick:u,title:"复制内容",disabled:c,children:(0,a.jsx)(l.g,{icon:c?n.z1G:n.jPR,className:c?"animate-spin":""})}),o.show&&(0,a.jsx)("div",{className:"absolute bg-green-500 text-white px-2 py-1 rounded shadow-lg",style:{top:o.position.y-30,left:o.position.x,zIndex:200},children:"复制成功"})]})}},5731:(e,t,s)=>{"use strict";s.d(t,{A:()=>o});var a=s(5155),r=s(7396),l=s(2115);function n(e){let{username:t,onLogout:s,onFetchUser:r,onRefreshToken:n}=e,[o,i]=(0,l.useState)(!1),c=(0,l.useRef)(null),d=t.length>10?"".concat(t.slice(0,10),"..."):t;return(0,l.useEffect)(()=>{let e=e=>{c.current&&!c.current.contains(e.target)&&i(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,a.jsxs)("div",{className:"relative",ref:c,children:[(0,a.jsx)("button",{onClick:()=>i(!o),className:"bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600",title:t,children:d}),o&&(0,a.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-50",children:[(0,a.jsx)("button",{onClick:r,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"魔法师信息"}),(0,a.jsx)("button",{onClick:n,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"更新魔法令牌"}),(0,a.jsx)("hr",{className:"border-gray-600"}),(0,a.jsx)("button",{onClick:s,className:"w-full text-left px-4 py-2 text-red-500 hover:bg-gray-700",children:"离开梦幻岛"})]})]})}function o(e){let{username:t,onLogout:s,onFetchUser:l,onRefreshToken:o,currentPath:i}=e;return(0,a.jsxs)("header",{className:"flex justify-between items-center fixed top-0 left-0 right-0 z-50 bg-gray-800 text-white p-2",children:[(0,a.jsx)("h1",{className:"text-xl md:text-2xl font-bold",children:"✨\uD83E\uDD8B 梦幻岛"}),(0,a.jsx)("div",{className:"flex space-x-4",children:["/publish","/chat","/knowledge","/agent"].map(e=>(0,a.jsx)(r.default,{href:e,children:(0,a.jsxs)("span",{className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(i===e?"bg-gradient-to-r from-blue-400 to-purple-400 text-white shadow-md":"bg-transparent text-gray-200 hover:bg-gray-600"),children:["/publish"===e&&"传说","/knowledge"===e&&"秘典","/agent"===e&&"精灵","/chat"===e&&"魔语"]})},e))}),(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsx)(n,{username:t,onLogout:s,onFetchUser:l,onRefreshToken:o})})]})}},5012:(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var a=s(5155),r=s(2115),l=s(8050);function n(e){var t,s;let{isOpen:n,knowledge:o,get_knowledge:i,onClose:c}=e,[d,u]=(0,r.useState)(null),[x,g]=(0,r.useState)(!1),[h,m]=(0,r.useState)(null);return((0,r.useEffect)(()=>{(async()=>{if(n&&(null==o?void 0:o.id)&&!d){g(!0),m(null);try{let e=await i(o.id);u(e)}catch(e){console.error("加载数据失败:",e),m("加载失败，请重试")}finally{g(!1)}}})()},[n,null==o?void 0:o.id]),n)?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&c()},children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl mx-4 my-6 w-full max-w-6xl h-[90vh] flex flex-col",children:[(0,a.jsx)("div",{className:"px-6 py-4 border-b",children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[(null==o?void 0:null===(t=o.tags)||void 0===t?void 0:t.length)>0&&(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:o.tags.map((e,t)=>(0,a.jsx)("span",{className:"px-2 py-0.5 text-xs bg-blue-50 text-blue-600 rounded-full",children:e},t))}),(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:[(0,a.jsxs)("div",{children:["ID: ",null==o?void 0:o.id]}),(null==o?void 0:o.source)&&(0,a.jsxs)("div",{children:["来源: ",o.source]})]})]})}),(0,a.jsx)("button",{className:"text-gray-500 hover:text-gray-700 transition-colors ml-4",onClick:c,children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:h?(0,a.jsx)("div",{className:"text-center text-red-500",children:h}):x?(0,a.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,a.jsx)("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"})}):(null==d?void 0:null===(s=d.content)||void 0===s?void 0:s.text)?(0,a.jsx)("div",{className:"prose prose-lg max-w-none",children:(0,a.jsx)(l.A,{content:d.content.text})}):(0,a.jsx)("div",{className:"text-center text-gray-500",children:"暂无内容"})}),(0,a.jsx)("div",{className:"px-6 py-3 border-t bg-gray-50",children:(0,a.jsx)("div",{className:"text-sm text-gray-500",children:(null==d?void 0:d.raw_meta)&&(0,a.jsxs)("details",{className:"mt-2",children:[(0,a.jsx)("summary",{className:"cursor-pointer hover:text-gray-700",children:"原始元数据"}),(0,a.jsx)("pre",{className:"mt-2 p-2 bg-gray-100 rounded text-xs overflow-x-auto",children:JSON.stringify(d.raw_meta,null,2)})]})})})]})}):null}},8050:(e,t,s)=>{"use strict";s.d(t,{A:()=>m});var a=s(5155);s(2115);var r=s(7564),l=s(7558),n=s(9054),o=s(7802),i=s(6731),c=s(7076),d=s(1883),u=s(8629),x=s(3273),g=s(4920);let h={...x.j,tagNames:[...x.j.tagNames,"question","final_answer","no_final_answer","context","knowledge","OUTLINE"],attributes:{...x.j.attributes,question:["className"],final_answer:["className"],no_final_answer:["className"],context:["className"],knowledge:["className"],OUTLINE:["className"]}};function m(e){let{content:t,className:s=""}=e,x=e=>{let{tagName:t,...s}=e;return(0,a.jsxs)("div",{className:"relative border border-blue-300 p-4 my-4 rounded-md bg-blue-50",children:[(0,a.jsx)("span",{className:"absolute top-0 left-2 bg-white px-2 text-xs text-blue-500 border border-blue-300 rounded -mt-2.5",children:t}),(0,a.jsx)("div",{...s})]})};return(0,a.jsx)("div",{className:"prose prose-sm max-w-none ".concat(s," bg-gray-100 p-2 rounded-lg shadow-md"),children:(0,a.jsx)(r.o,{remarkPlugins:[l.A,n.A,c.A,d.A],rehypePlugins:[u.A,(0,g.A)(h),o.A,i.A],components:{question:e=>(0,a.jsx)(x,{tagName:"question",...e}),final_answer:e=>(0,a.jsx)(x,{tagName:"final_answer",...e}),no_final_answer:e=>(0,a.jsx)(x,{tagName:"no_final_answer",...e}),context:e=>(0,a.jsx)(x,{tagName:"context",...e}),knowledge:e=>(0,a.jsx)(x,{tagName:"knowledge",...e}),OUTLINE:e=>(0,a.jsx)(x,{tagName:"OUTLINE",...e}),h1:e=>{let{node:t,...s}=e;return(0,a.jsx)("h1",{className:"text-3xl font-bold my-4",...s})},h2:e=>{let{node:t,...s}=e;return(0,a.jsx)("h2",{className:"text-2xl font-semibold my-3",...s})},p:e=>{let{node:t,...s}=e;return(0,a.jsx)("p",{className:"text-base leading-relaxed my-2",...s})},pre:e=>{let{node:t,...s}=e;return(0,a.jsx)("pre",{className:"bg-gray-800 text-white p-4 rounded-md my-4 overflow-x-auto",...s})}},children:t||""})})}},3201:(e,t,s)=>{"use strict";s.d(t,{A:()=>c,O:()=>i});var a=s(5155),r=s(6046),l=s(2115),n=s(2492);let o=(0,l.createContext)(),i=e=>{let{children:t}=e,[s,i]=(0,l.useState)(null),[c,d]=(0,l.useState)(!0),u=(0,r.useRouter)(),x=(0,r.usePathname)();(0,l.useEffect)(()=>{(async()=>{if("/login"===x){d(!1);return}try{let e=await (0,n.im)();e.username?i(e):u.push("/login")}catch(e){i(null),u.push("/login")}finally{d(!1)}})()},[x]);let g=async(e,t)=>{try{let s=await (0,n.iD)(e,t);return s&&i(s),s}catch(e){throw console.error("登录失败:",e),e}},h=async()=>{try{i(null),await (0,n.ri)()}catch(e){console.error("登出错误:",e)}u.push("/login")},m=async()=>{try{await (0,n.Be)()}catch(e){console.error("刷新令牌错误:",e)}},p=async()=>{try{let e=await (0,n.im)();i(e)}catch(e){console.error("获取用户信息错误:",e)}};return(0,a.jsx)(o.Provider,{value:{user:s,loading:c,login:g,logout:h,refreshToken:m,fetchUser:p},children:t})},c=()=>(0,l.useContext)(o)},5370:(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var a=s(2651),r=s(6828);let l=a.A.create({baseURL:r.J,withCredentials:!0});l.interceptors.response.use(e=>e,async e=>{let t=e.config;if(e.response&&401===e.response.status&&!t._retry){t._retry=!0;try{return await l.post("/api/auth/refresh-token",{},{withCredentials:!0}),l(t)}catch(e){return(0,r.t)(e),Promise.reject(e)}}return e.response&&403===e.response.status&&console.error("访问被拒绝:",e),(0,r.t)(e),Promise.reject(e)});let n=l},2492:(e,t,s)=>{"use strict";s.d(t,{Be:()=>o,iD:()=>r,im:()=>n,ri:()=>l});var a=s(5370);let r=async(e,t)=>{try{let s=new URLSearchParams;s.append("grant_type","password"),s.append("username",e),s.append("password",t);let r=await a.A.post("/api/auth/login",s,{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(!r.request.withCredentials)return alert("请检查浏览器隐私设置：客户端无法保存 Cookie 导致登录失败！"),null;return r.data}catch(e){throw console.error("登录失败:",e.response?e.response.data:e.message),Error("登录失败，请检查您的凭据并重试。")}},l=async()=>{try{await a.A.post("/api/auth/logout",{},{withCredentials:!0})}catch(e){if(e.response&&401===e.response.status)return;throw Error("登出失败")}},n=async()=>{try{return(await a.A.get("/api/auth/profile")).data}catch(e){console.log("获取用户信息失败")}},o=async()=>{try{await a.A.post("/api/auth/refresh-token",{},{withCredentials:!0})}catch(e){console.log("刷新令牌失败")}}},6828:(e,t,s)=>{"use strict";s.d(t,{J:()=>r,t:()=>l});var a=s(5521);let r="http://localhost:8001",l=e=>{e.response&&401===e.response.status?console.log("未授权，重定向到登录页"):console.log("API 请求错误:",e),a.default.push("/login")}},518:(e,t,s)=>{"use strict";s.d(t,{oX:()=>l,zH:()=>r,zo:()=>n});var a=s(5370);let r=async function(){let{page:e=1,pageSize:t=10,sortBy:s="id",reverse:r=!1,tags:l=null,matchAllTags:n=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o={page:e,page_size:t,sort_by:s,reverse:r,...(null==l?void 0:l.length)&&{tags:l,match_all_tags:n}};try{return(await a.A.get("/api/knowledge",{params:o})).data}catch(e){throw console.error("获取知识列表失败:",e),e}},l=async e=>{try{return(await a.A.get("/api/knowledge/".concat(e))).data}catch(t){throw console.error("获取知识[".concat(e,"]失败:"),t),t}},n=async(e,t)=>{let{content:s=null,tags:r=null,summary:l=null,source:n=null}=t,o=new FormData;null!==s&&o.append("content",s),null!==r&&o.append("tags",r.join(",")),null!==l&&o.append("summary",l),null!==n&&o.append("source",n);try{return(await a.A.put("/api/knowledge/".concat(e),o)).data}catch(t){throw console.error("更新知识[".concat(e,"]失败:"),t),t}}}},e=>{var t=t=>e(e.s=t);e.O(0,[779,420,804,19,622,694,432,592,331,271,30,519,408,473,376,358],()=>t(1892)),_N_E=e.O()}]);