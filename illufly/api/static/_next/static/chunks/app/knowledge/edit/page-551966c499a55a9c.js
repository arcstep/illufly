(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[678,792],{1226:()=>{},7691:(e,t,s)=>{Promise.resolve().then(s.bind(s,6580))},6580:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>x});var r=s(5155),n=s(2115),a=s(7396),l=s(518),o=s(3201),c=s(5731),i=s(8050);function u(e){let{onClick:t,isContentChanged:s=!0}=e,[a,l]=(0,n.useState)({show:!1,type:"success",position:{x:0,y:0}}),[o,c]=(0,n.useState)(s);(0,n.useEffect)(()=>{s&&c(!0)},[s]);let i=async e=>{try{await (null==t?void 0:t(e)),l({show:!0,type:"success",position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>{l({show:!1,position:{x:0,y:0}}),setTimeout(()=>c(!1),200)},1500)}catch(t){l({show:!0,type:"error",position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>l({show:!1,position:{x:0,y:0}}),1500)}};return o?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("button",{className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors",onClick:i,children:[(0,r.jsx)("svg",{className:"w-4 h-4 mr-1.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),"保存"]}),a.show&&(0,r.jsx)("div",{className:"absolute text-white px-2 py-1 rounded shadow-lg ".concat("success"===a.type?"bg-green-500":"bg-red-500"),style:{top:a.position.y-30,left:a.position.x,zIndex:200},children:"success"===a.type?"保存成功":"保存失败"})]}):null}function d(e){let{tags:t=[],onChange:s}=e,[a,l]=(0,n.useState)(""),o=(0,n.useRef)(null),c=e=>{s(t.filter((t,s)=>s!==e))};return(0,r.jsxs)("div",{className:"flex items-center flex-wrap gap-2",children:[t.map((e,t)=>(0,r.jsxs)("span",{className:"px-2 py-0.5 bg-blue-50 text-blue-600 rounded-full text-xs flex items-center group",children:[e,(0,r.jsx)("button",{onClick:()=>c(t),className:"ml-1 text-blue-400 hover:text-blue-600",children:"\xd7"})]},t)),(0,r.jsx)("input",{ref:o,type:"text",value:a,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"===e.key&&a.trim()?(e.preventDefault(),t.includes(a.trim())||s([...t,a.trim()]),l("")):"Backspace"===e.key&&!a&&t.length>0&&s(t.slice(0,-1))},className:"outline-none border-none bg-transparent text-sm min-w-20 flex-grow",placeholder:0===t.length?"输入标签后按回车添加":""})]})}function x(){let{user:e,logout:t,fetchUser:s,refreshToken:x}=(0,o.A)(),[m,h]=(0,n.useState)(!0),[g,p]=(0,n.useState)(null),[f,w]=(0,n.useState)(""),[y,b]=(0,n.useState)(null),j=(0,n.useRef)(null),[v,N]=(0,n.useState)(!1),[k,C]=(0,n.useState)(""),[A,_]=(0,n.useState)([]),[S,E]=(0,n.useState)(!1),[L,T]=(0,n.useState)(""),[D,P]=(0,n.useState)(""),[R,z]=(0,n.useState)(!1),H=(0,n.useRef)(null),[I,O]=(0,n.useState)(null);(0,n.useEffect)(()=>{{let{searchParams:e}=new URL(window.location.href),t=e.get("knowledge_id");b(t),U(t)}},[s]);let U=async e=>{if(e){h(!0);try{let t=await (0,l.oX)(e);if(null==t?void 0:t.content){let e=t.content.text,s=t.content.meta.summary||"",r=t.content.meta.tags||[];p(t),w(e),C(e),T(s),P(s),_(r),N(!1),z(!1),E(!1)}}catch(e){console.error("Error loading knowledge content:",e)}finally{h(!1)}}},B=e=>{if(j.current){let t=e.scrollTop/(e.scrollHeight-e.clientHeight),s=j.current.scrollHeight-j.current.clientHeight;j.current.scrollTop=t*s}},q=e=>{if(H.current){let t=e.scrollTop/(e.scrollHeight-e.clientHeight),s=H.current.scrollHeight-H.current.clientHeight;H.current.scrollTop=t*s}},F=async()=>{if(!y)throw console.error("Knowledge ID is not set"),Error("Knowledge ID is not set");try{return await (0,l.zo)(y,{content:v?f:null,tags:S?A:null,summary:R?L:null}),C(f),P(L),N(!1),z(!1),E(!1),await U(y),!0}catch(e){throw console.error("知识更新失败:",e),e}};return(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,r.jsx)(c.A,{username:(null==e?void 0:e.username)||"加载中...",onLogout:t,onFetchUser:s,onRefreshToken:x,currentPath:"/knowledge"}),(0,r.jsx)("main",{className:"container mx-auto px-4 py-6 max-w-7xl",children:(0,r.jsxs)("div",{className:"flex-1 flex flex-col p-4 overflow-hidden",children:[(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-sm p-4 mb-4",children:(0,r.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,r.jsx)("div",{className:"flex justify-between items-center",children:(0,r.jsxs)("div",{className:"flex items-center space-x-6",children:[(0,r.jsxs)(a.default,{href:"/knowledge",className:"flex items-center text-blue-600 hover:text-blue-700 transition-colors",children:[(0,r.jsx)("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"返回"]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2 text-gray-600",children:[(0,r.jsx)("span",{className:"font-medium",children:"文档ID:"}),(0,r.jsx)("code",{className:"px-2 py-1 bg-gray-100 rounded text-sm",children:y})]})]})}),(0,r.jsxs)("div",{className:"flex items-center space-x-2 px-2",children:[(0,r.jsx)("span",{className:"font-medium text-gray-600",children:"标签:"}),(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsx)(d,{tags:A,onChange:e=>{var t,s;let r=(null==g?void 0:null===(s=g.content)||void 0===s?void 0:null===(t=s.meta)||void 0===t?void 0:t.tags)||[],n=JSON.stringify(e)!==JSON.stringify(r);_(e),E(n)}})}),(0,r.jsx)(u,{onClick:F,isContentChanged:v||S||R})]})]})}),!m&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"bg-white rounded-xl shadow-sm",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-100",children:[(0,r.jsx)("h2",{className:"text-sm font-medium text-gray-700",children:"文档摘要"}),(0,r.jsx)("button",{onClick:()=>O("summary"===I?null:"summary"),className:"text-sm px-3 py-1 rounded-md transition-colors ".concat("summary"===I?"bg-blue-50 text-blue-600":"text-gray-500 hover:bg-gray-50"),children:"summary"===I?"完成编辑":"编辑摘要"})]}),(0,r.jsx)("div",{className:"p-4",children:"summary"===I?(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsx)("div",{ref:H,className:"prose prose-sm max-w-none",children:(0,r.jsx)(i.A,{content:L})}),(0,r.jsx)("div",{className:"flex flex-col",children:(0,r.jsx)("textarea",{className:"w-full h-[200px] p-4 border rounded-lg resize-none  font-mono text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500",value:L,onChange:e=>{let t=e.target.value;T(t),z(t!==D),q(e.target)},onScroll:e=>q(e.target),placeholder:"在此输入文档摘要..."})})]}):(0,r.jsx)("div",{className:"prose prose-sm max-w-none",children:(0,r.jsx)(i.A,{content:L})})})]}),(0,r.jsxs)("div",{className:"bg-white rounded-xl shadow-sm",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-100",children:[(0,r.jsx)("h2",{className:"text-sm font-medium text-gray-700",children:"正文内容"}),(0,r.jsx)("button",{onClick:()=>O("content"===I?null:"content"),className:"text-sm px-3 py-1 rounded-md transition-colors ".concat("content"===I?"bg-blue-50 text-blue-600":"text-gray-500 hover:bg-gray-50"),children:"content"===I?"完成编辑":"编辑正文"})]}),(0,r.jsx)("div",{className:"p-4",children:"content"===I?(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsx)("div",{ref:j,className:"prose prose-sm max-w-none",children:(0,r.jsx)(i.A,{content:f})}),(0,r.jsx)("div",{className:"flex flex-col",children:(0,r.jsx)("textarea",{className:"w-full h-[500px] p-4 border rounded-lg resize-none  font-mono text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500",value:f,onChange:e=>{let t=e.target.value;w(t),N(t!==k),B(e.target)},onScroll:e=>B(e.target),placeholder:"在此输入正文内容..."})})]}):(0,r.jsx)("div",{className:"prose prose-sm max-w-none",children:(0,r.jsx)(i.A,{content:f})})})]})]})]})})]})}},5731:(e,t,s)=>{"use strict";s.d(t,{A:()=>o});var r=s(5155),n=s(7396),a=s(2115);function l(e){let{username:t,onLogout:s,onFetchUser:n,onRefreshToken:l}=e,[o,c]=(0,a.useState)(!1),i=(0,a.useRef)(null),u=t.length>10?"".concat(t.slice(0,10),"..."):t;return(0,a.useEffect)(()=>{let e=e=>{i.current&&!i.current.contains(e.target)&&c(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,r.jsxs)("div",{className:"relative",ref:i,children:[(0,r.jsx)("button",{onClick:()=>c(!o),className:"bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600",title:t,children:u}),o&&(0,r.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-50",children:[(0,r.jsx)("button",{onClick:n,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"魔法师信息"}),(0,r.jsx)("button",{onClick:l,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"更新魔法令牌"}),(0,r.jsx)("hr",{className:"border-gray-600"}),(0,r.jsx)("button",{onClick:s,className:"w-full text-left px-4 py-2 text-red-500 hover:bg-gray-700",children:"离开梦幻岛"})]})]})}function o(e){let{username:t,onLogout:s,onFetchUser:a,onRefreshToken:o,currentPath:c}=e;return(0,r.jsxs)("header",{className:"flex justify-between items-center fixed top-0 left-0 right-0 z-50 bg-gray-800 text-white p-2",children:[(0,r.jsx)("h1",{className:"text-xl md:text-2xl font-bold",children:"✨\uD83E\uDD8B 梦幻岛"}),(0,r.jsx)("div",{className:"flex space-x-4",children:["/publish","/chat","/knowledge","/agent"].map(e=>(0,r.jsx)(n.default,{href:e,children:(0,r.jsxs)("span",{className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(c===e?"bg-gradient-to-r from-blue-400 to-purple-400 text-white shadow-md":"bg-transparent text-gray-200 hover:bg-gray-600"),children:["/publish"===e&&"传说","/knowledge"===e&&"秘典","/agent"===e&&"精灵","/chat"===e&&"魔语"]})},e))}),(0,r.jsx)("div",{className:"flex items-center",children:(0,r.jsx)(l,{username:t,onLogout:s,onFetchUser:a,onRefreshToken:o})})]})}},8050:(e,t,s)=>{"use strict";s.d(t,{A:()=>g});var r=s(5155);s(2115);var n=s(7564),a=s(7558),l=s(9054),o=s(7802),c=s(6731),i=s(7076),u=s(1883),d=s(8629),x=s(3273),m=s(4920);let h={...x.j,tagNames:[...x.j.tagNames,"question","final_answer","no_final_answer","context","knowledge","OUTLINE"],attributes:{...x.j.attributes,question:["className"],final_answer:["className"],no_final_answer:["className"],context:["className"],knowledge:["className"],OUTLINE:["className"]}};function g(e){let{content:t,className:s=""}=e,x=e=>{let{tagName:t,...s}=e;return(0,r.jsxs)("div",{className:"relative border border-blue-300 p-4 my-4 rounded-md bg-blue-50",children:[(0,r.jsx)("span",{className:"absolute top-0 left-2 bg-white px-2 text-xs text-blue-500 border border-blue-300 rounded -mt-2.5",children:t}),(0,r.jsx)("div",{...s})]})};return(0,r.jsx)("div",{className:"prose prose-sm max-w-none ".concat(s," bg-gray-100 p-2 rounded-lg shadow-md"),children:(0,r.jsx)(n.o,{remarkPlugins:[a.A,l.A,i.A,u.A],rehypePlugins:[d.A,(0,m.A)(h),o.A,c.A],components:{question:e=>(0,r.jsx)(x,{tagName:"question",...e}),final_answer:e=>(0,r.jsx)(x,{tagName:"final_answer",...e}),no_final_answer:e=>(0,r.jsx)(x,{tagName:"no_final_answer",...e}),context:e=>(0,r.jsx)(x,{tagName:"context",...e}),knowledge:e=>(0,r.jsx)(x,{tagName:"knowledge",...e}),OUTLINE:e=>(0,r.jsx)(x,{tagName:"OUTLINE",...e}),h1:e=>{let{node:t,...s}=e;return(0,r.jsx)("h1",{className:"text-3xl font-bold my-4",...s})},h2:e=>{let{node:t,...s}=e;return(0,r.jsx)("h2",{className:"text-2xl font-semibold my-3",...s})},p:e=>{let{node:t,...s}=e;return(0,r.jsx)("p",{className:"text-base leading-relaxed my-2",...s})},pre:e=>{let{node:t,...s}=e;return(0,r.jsx)("pre",{className:"bg-gray-800 text-white p-4 rounded-md my-4 overflow-x-auto",...s})}},children:t||""})})}},3201:(e,t,s)=>{"use strict";s.d(t,{A:()=>i,O:()=>c});var r=s(5155),n=s(6046),a=s(2115),l=s(2492);let o=(0,a.createContext)(),c=e=>{let{children:t}=e,[s,c]=(0,a.useState)(null),[i,u]=(0,a.useState)(!0),d=(0,n.useRouter)(),x=(0,n.usePathname)();(0,a.useEffect)(()=>{(async()=>{if("/login"===x){u(!1);return}try{let e=await (0,l.im)();e.username?c(e):d.push("/login")}catch(e){c(null),d.push("/login")}finally{u(!1)}})()},[x]);let m=async(e,t)=>{try{let s=await (0,l.iD)(e,t);return s&&c(s),s}catch(e){throw console.error("登录失败:",e),e}},h=async()=>{try{c(null),await (0,l.ri)()}catch(e){console.error("登出错误:",e)}d.push("/login")},g=async()=>{try{await (0,l.Be)()}catch(e){console.error("刷新令牌错误:",e)}},p=async()=>{try{let e=await (0,l.im)();c(e)}catch(e){console.error("获取用户信息错误:",e)}};return(0,r.jsx)(o.Provider,{value:{user:s,loading:i,login:m,logout:h,refreshToken:g,fetchUser:p},children:t})},i=()=>(0,a.useContext)(o)},5370:(e,t,s)=>{"use strict";s.d(t,{A:()=>l});var r=s(2651),n=s(6828);let a=r.A.create({baseURL:n.J,withCredentials:!0});a.interceptors.response.use(e=>e,async e=>{let t=e.config;if(e.response&&401===e.response.status&&!t._retry){t._retry=!0;try{return await a.post("/api/auth/refresh-token",{},{withCredentials:!0}),a(t)}catch(e){return(0,n.t)(e),Promise.reject(e)}}return e.response&&403===e.response.status&&console.error("访问被拒绝:",e),(0,n.t)(e),Promise.reject(e)});let l=a},2492:(e,t,s)=>{"use strict";s.d(t,{Be:()=>o,iD:()=>n,im:()=>l,ri:()=>a});var r=s(5370);let n=async(e,t)=>{try{let s=new URLSearchParams;s.append("grant_type","password"),s.append("username",e),s.append("password",t);let n=await r.A.post("/api/auth/login",s,{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(!n.request.withCredentials)return alert("请检查浏览器隐私设置：客户端无法保存 Cookie 导致登录失败！"),null;return n.data}catch(e){throw console.error("登录失败:",e.response?e.response.data:e.message),Error("登录失败，请检查您的凭据并重试。")}},a=async()=>{try{await r.A.post("/api/auth/logout",{},{withCredentials:!0})}catch(e){if(e.response&&401===e.response.status)return;throw Error("登出失败")}},l=async()=>{try{return(await r.A.get("/api/auth/profile")).data}catch(e){console.log("获取用户信息失败")}},o=async()=>{try{await r.A.post("/api/auth/refresh-token",{},{withCredentials:!0})}catch(e){console.log("刷新令牌失败")}}},6828:(e,t,s)=>{"use strict";s.d(t,{J:()=>n,t:()=>a});var r=s(5521);let n="http://localhost:8001",a=e=>{e.response&&401===e.response.status?console.log("未授权，重定向到登录页"):console.log("API 请求错误:",e),r.default.push("/login")}},518:(e,t,s)=>{"use strict";s.d(t,{oX:()=>a,zH:()=>n,zo:()=>l});var r=s(5370);let n=async function(){let{page:e=1,pageSize:t=10,sortBy:s="id",reverse:n=!1,tags:a=null,matchAllTags:l=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o={page:e,page_size:t,sort_by:s,reverse:n,...(null==a?void 0:a.length)&&{tags:a,match_all_tags:l}};try{return(await r.A.get("/api/knowledge",{params:o})).data}catch(e){throw console.error("获取知识列表失败:",e),e}},a=async e=>{try{return(await r.A.get("/api/knowledge/".concat(e))).data}catch(t){throw console.error("获取知识[".concat(e,"]失败:"),t),t}},l=async(e,t)=>{let{content:s=null,tags:n=null,summary:a=null,source:l=null}=t,o=new FormData;null!==s&&o.append("content",s),null!==n&&o.append("tags",n.join(",")),null!==a&&o.append("summary",a),null!==l&&o.append("source",l);try{return(await r.A.put("/api/knowledge/".concat(e),o)).data}catch(t){throw console.error("更新知识[".concat(e,"]失败:"),t),t}}}},e=>{var t=t=>e(e.s=t);e.O(0,[779,420,804,19,622,694,432,592,331,271,30,519,408,473,376,358],()=>t(7691)),_N_E=e.O()}]);