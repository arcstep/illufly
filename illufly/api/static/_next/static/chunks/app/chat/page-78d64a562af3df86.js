(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457,792],{1226:()=>{},7386:(e,t,s)=>{Promise.resolve().then(s.bind(s,3813))},3813:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>I});var l=s(5155),r=s(2115),a=s(3201),n=s(5731),i=s(9757),o=s(5055);function c(e){let{onChangeAgent:t,selected_agent:s,setIsAgentListVisible:r,isAgentListVisible:a,setIsHistoryListVisible:n,isHistoryListVisible:c}=e;return(0,l.jsxs)("div",{className:"w-full md:w-1/6 p-4 border-b md:border-b-0 md:border-r flex flex-col",children:[(0,l.jsxs)("div",{className:"mt-12 flex ".concat(a?"flex-row":"flex-col"),children:[r&&(0,l.jsx)("button",{onClick:()=>r(!a),className:"mr-2 px-3 py-1 rounded-full transition-all duration-300 ".concat(a?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.UBk,style:{color:a?"white":"lightgray"}})}),n&&(0,l.jsx)("button",{onClick:()=>n(!c),className:"mr-2 px-3 py-1 rounded-full transition-all duration-300 ".concat(c?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.Int,style:{color:c?"white":"lightgray"}})})]}),(0,l.jsx)("ul",{className:"mt-4 flex-1 overflow-y-auto md:max-h-none max-h-64 min-h-32",children:[{id:"fake_llm",name:"模拟",icon:"\uD83E\uDD16"},{id:"chat",name:"聊天",icon:"\uD83D\uDCAC"},{id:"learn",name:"训练",icon:"\uD83E\uDDD1‍\uD83C\uDF93"}].map(e=>(0,l.jsxs)("li",{className:"cursor-pointer p-2 mb-2 flex items-center rounded-full transition-all duration-300 ".concat(s===e.id?"bg-blue-300 text-white shadow-md":"bg-gray-300 text-gray-800 hover:bg-gray-400"),onClick:()=>t(e.id),children:[(0,l.jsx)("span",{className:"mr-2",children:e.icon}),(0,l.jsx)("span",{children:e.name})]},e.id))})]})}function d(e){let{agents:t,onChangeAgent:s,selected_agent:r,toggleAgentList:a,toggleHistoryList:n,isAgentListVisible:c,isHistoryListVisible:d}=e;return(0,l.jsxs)("div",{className:"mt-12 flex flex-col items-center space-y-2",children:[(0,l.jsx)("button",{onClick:a,className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(c?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.UBk,style:{color:c?"white":"lightgray"}})}),(0,l.jsx)("button",{onClick:n,className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(d?"bg-gradient-to-r from-yellow-400 to-red-500 text-white shadow-lg":"bg-gray-700 text-white hover:bg-gray-600"),children:(0,l.jsx)(i.g,{icon:o.Int,style:{color:d?"white":"lightgray"}})}),t.map(e=>(0,l.jsx)("div",{className:"cursor-pointer p-2 mb-2 flex items-center rounded-full transition-all duration-300 ".concat(r===e.id?"bg-blue-300 text-white shadow-md":"bg-gray-300 text-gray-800 hover:bg-gray-400"),onClick:()=>s(e.id),children:(0,l.jsx)("span",{className:"mr-2",children:e.icon})},e.id))]})}function u(e){var t;let{tabs:s,selectedTab:r,onSelectTab:a}=e;return(0,l.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,l.jsx)("ul",{className:"flex border-b-2 border-gray-200 bg-white sticky top-0 z-10",children:s.map(e=>(0,l.jsx)("li",{className:"cursor-pointer p-2 ".concat(r===e.key?"border-b-2 border-blue-500":""),onClick:()=>a(e.key),children:e.label},e.key))}),(0,l.jsx)("div",{className:"flex-1 overflow-y-auto h-full",children:null===(t=s.find(e=>e.key===r))||void 0===t?void 0:t.content})]})}function x(e){let{historyId:t,historyList:s,onSelectHistory:r,onNewHistory:a}=e;return Array.isArray(s)?(0,l.jsxs)("div",{className:"w-full max-w-xs p-4 border-b md:border-b-0 md:border-r flex flex-col h-full",children:[(0,l.jsx)("div",{className:"flex justify-center mb-4",children:(0,l.jsx)("button",{onClick:a,className:"w-full p-2 bg-gray-300 text-black rounded",children:"+ 新建对话"})}),(0,l.jsx)("div",{className:"flex-1 overflow-y-auto md:max-h-none max-h-64 min-h-32",children:s.map(e=>(0,l.jsx)("button",{onClick:()=>r(e),className:"p-2 rounded mb-1 ".concat(e===t?"bg-blue-500 text-white":"bg-gray-300 text-black"),children:e},e))})]}):(console.error("historyList is not an array"),null)}var h=s(8050),m=s(5012),g=s(4572);function f(e){let{content:t}=e,[s,a]=(0,r.useState)(!1),[n,i]=(0,r.useState)(""),[o,c]=(0,r.useState)(!1),d=JSON.parse(t),u=d.filter(e=>{var t;return(null===(t=e.meta)||void 0===t?void 0:t.distance)<1}),x=o?d.slice(0,3):u,f=e=>{i(e),a(!0)};return(0,l.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,l.jsx)("div",{className:"flex space-x-4 overflow-x-auto",children:x.map((e,t)=>{var s,r;return(0,l.jsxs)("div",{className:"bg-white p-4 rounded shadow-sm border border-gray-200",children:[(null===(s=e.meta)||void 0===s?void 0:s.source)&&(0,l.jsx)("div",{className:"text-sm font-semibold text-gray-800",children:e.meta.source}),e.text?(0,l.jsx)(h.A,{content:e.text.substring(0,100)+"...",className:"text-xs text-gray-600 mt-1"}):(0,l.jsx)("div",{className:"text-xs text-gray-600 mt-1",children:"没有可展示的内容"}),(0,l.jsxs)("div",{className:"flex items-center mt-2",children:[(null===(r=e.meta)||void 0===r?void 0:r.distance)!==void 0&&(0,l.jsx)("span",{className:"inline-block bg-yellow-100 text-yellow-800 rounded-full px-2 py-0.5",children:e.meta.distance.toFixed(2)}),(0,l.jsx)("button",{className:"ml-auto text-blue-500 text-sm",onClick:()=>f(e.text),children:"查看详情"}),(0,l.jsx)(g.A,{content:e.text})]})]},t)})}),(0,l.jsx)("button",{className:"text-blue-500 text-sm mt-2",onClick:()=>{c(!o)},children:o?"仅展示强相关检索结果":"展示全部".concat(d.length,"个检索结果")}),(0,l.jsx)(m.A,{isOpen:s,content:n,onClose:()=>{a(!1),i("")}})]})}function p(e){let{messages:t}=e,s=(0,r.useRef)(null),[a,n]=(0,r.useState)([]),[c,d]=(0,r.useState)({});(0,r.useEffect)(()=>{var e;null===(e=s.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[t]);let u=e=>{n(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},x=(e,t)=>{d(s=>{var l;return{...s,[e]:{...s[e],[t]:!(null===(l=s[e])||void 0===l?void 0:l[t])}}})};return(0,l.jsxs)("div",{className:"h-full flex flex-col bg-gray-50",children:[(0,l.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,l.jsxs)("ul",{children:[t.map(e=>{var t,s,r,n,d,m;return(0,l.jsxs)("li",{className:"flex items-start relative group mb-4 p-4 rounded-lg shadow-sm bg-white \n                                ".concat(a.includes(e.id)?"border-2 border-blue-500":"border border-gray-200"),children:[(0,l.jsxs)("div",{className:"flex flex-col items-center mr-4",children:[e.logo,(0,l.jsxs)("div",{className:"mt-2 flex flex-col items-center \n                                        ".concat(a.includes(e.id)||(null===(t=c[e.id])||void 0===t?void 0:t.star)||(null===(s=c[e.id])||void 0===s?void 0:s.like)||(null===(r=c[e.id])||void 0===r?void 0:r.dislike)?"opacity-100":"opacity-0 group-hover:opacity-100"," transition-opacity duration-300"),children:[(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full mb-2 flex items-center justify-center \n                                            ".concat(a.includes(e.id)?"bg-blue-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>u(e.id),title:"点击选择/取消选择",children:(0,l.jsx)(i.g,{icon:o.e68})}),(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full mb-2 flex items-center justify-center \n                                            ".concat((null===(n=c[e.id])||void 0===n?void 0:n.star)?"bg-yellow-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>x(e.id,"star"),title:"收藏",children:(0,l.jsx)(i.g,{icon:o.yy})}),"你"!==e.name&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full mb-2 flex items-center justify-center \n                                                    ".concat((null===(d=c[e.id])||void 0===d?void 0:d.like)?"bg-green-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>x(e.id,"like"),title:"点赞",children:(0,l.jsx)(i.g,{icon:o.Wcv})}),(0,l.jsx)("button",{className:"cursor-pointer w-6 h-6 rounded-full flex items-center justify-center \n                                                    ".concat((null===(m=c[e.id])||void 0===m?void 0:m.dislike)?"bg-red-500 text-white":"bg-gray-300 text-gray-500"),onClick:()=>x(e.id,"dislike"),title:"踩",children:(0,l.jsx)(i.g,{icon:o.lS9})})]})]})]}),(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsx)("div",{className:"font-semibold text-gray-800",children:e.name}),e.segments.map((t,s)=>(0,l.jsxs)("div",{className:"bg-white p-2 mb-2 rounded",children:[(0,l.jsxs)("div",{className:"flex items-center text-xs text-gray-500 mb-1",children:[(0,l.jsx)("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5",children:t.type.toUpperCase()}),["human","chunk"].includes(t.type)&&(0,l.jsx)(g.A,{content:t.content}),(0,l.jsx)("span",{className:"text-gray-400 ml-auto",children:e.timestamp})]}),"rag"===t.type?(0,l.jsx)(f,{content:t.content}):(0,l.jsx)(h.A,{content:t.content,className:"text-sm text-gray-700 prose prose-sm max-w-none"})]},s))]})]},e.id)}),(0,l.jsx)("div",{ref:s})]})}),a.length>0&&(0,l.jsxs)("div",{className:"sticky bottom-0 bg-white p-2 shadow-md flex justify-between",children:[(0,l.jsx)("button",{className:"text-blue-500",onClick:()=>{console.log("分享消息:",t.filter(e=>a.includes(e.id)))},children:"分享选中的消息"}),(0,l.jsx)("button",{className:"text-red-500",onClick:()=>{n([])},children:"取消分享"})]})]})}function y(e){let{onSendMessage:t}=e,[s,a]=(0,r.useState)(""),[n,c]=(0,r.useState)([]),d=e=>{c(t=>t.filter(t=>t.name!==e))};return(0,l.jsx)("div",{className:"sticky bottom-0 bg-gray-100 p-4 shadow-inner",children:(0,l.jsxs)("div",{className:"flex flex-col bg-white p-3 rounded-lg shadow-md",children:[n.length>0&&(0,l.jsx)("div",{className:"flex flex-wrap mb-2",children:n.map((e,t)=>(0,l.jsxs)("div",{className:"flex items-center text-sm text-gray-600 mr-2 mb-1",children:[(0,l.jsx)("span",{className:"mr-1",children:e.name}),(0,l.jsx)("button",{className:"text-red-500 hover:text-red-600",onClick:()=>d(e.name),children:(0,l.jsx)(i.g,{icon:o.GRI})})]},t))}),(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsxs)("label",{className:"flex items-center cursor-pointer text-blue-500 hover:text-blue-600 mr-2",children:[(0,l.jsx)(i.g,{icon:o.WMI}),(0,l.jsx)("input",{type:"file",className:"hidden",multiple:!0,onChange:e=>{let t=Array.from(e.target.files);c(e=>[...e,...t])}})]}),(0,l.jsx)("textarea",{className:"flex-1 p-3 m-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out",rows:"1",style:{maxHeight:"10em",resize:"none",overflowY:"auto"},placeholder:"输入你的消息...",value:s,onChange:e=>a(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),s.trim()&&(t(s),a(""),e.target.style.height="auto"))},onInput:e=>{let t=e.target;t.style.height="auto",t.style.height="".concat(Math.min(t.scrollHeight,160),"px")}}),(0,l.jsx)("button",{className:"bg-blue-400 text-white px-4 py-2 ml-2 rounded-lg shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 transition duration-150 ease-in-out",onClick:e=>{s.trim()&&(t(s),a(""),e.target.previousSibling.style.height="auto")},children:"发送"})]})]})})}var b=s(6828),j=s(2492);let v=async function(e,t,s){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=null;return await (0,j.Be)(),(()=>{let a=new URL(b.J+e);l.params&&Object.keys(l.params).forEach(e=>a.searchParams.append(e,l.params[e])),(r=new EventSource(a,{withCredentials:!0})).onmessage=e=>{try{let s=JSON.parse(e.data);t(s.calling_id,s)}catch(e){console.error("JSON 解析错误:",e),s&&s(e)}},r.onerror=e=>{r.close()}})(),{stop:()=>{r&&r.close()}}};var w=s(5370);let N=async(e,t,s,l)=>{await v("/api/".concat(e||"fake_llm"),s,l,{params:{prompt:t}})},k=async(e,t,s)=>{w.A.get("/api/".concat(e||"fake_llm","/history/list")).then(t).catch(s)},C=async(e,t,s,l)=>{let r=new FormData;r.append("history_id",t),w.A.post("/api/".concat(e||"fake_llm","/history/change"),r).then(s).catch(l)},A=async(e,t,s)=>{w.A.post("/api/".concat(e||"fake_llm","/history/new")).then(t).catch(s)},_=["text","chunk","tool_resp_text","tool_resp_chunk"],S=[];function L(e){let{agent:t,setAgent:s,isHistoryListVisible:a}=e,[n,c]=(0,r.useState)([]),[d,u]=(0,r.useState)(""),[h,m]=(0,r.useState)([]),g=(0,r.useRef)(h),f=(0,r.useRef)([]),b=(0,r.useRef)(null);(0,r.useEffect)(()=>{j(t)},[t]),(0,r.useEffect)(()=>{g.current=h},[h]);let j=async e=>{s(e),k(e,t=>{L(e,t.data.history_id),Array.isArray(t.data.history_list)?c(t.data.history_list):(console.error("获取的历史记录列表不是数组:",t.data),c([]))},e=>{console.log("获取历史记录列表失败:",e)})},v=async()=>{await A(t,e=>{c(t=>[e.data,...t]),u(e.data),m([])})},w=async e=>{L(t,e)},L=async(e,t)=>{u(t);try{await C(e,t,e=>{let t=[];for(let s in e.data.history){let r=e.data.history[s],a=null,n=null;r.forEach(e=>{let{block_type:t,content:r,content_id:c,created_at:d}=JSON.parse(e.data);if("human"===t)a||(a={id:"".concat(s,"-human"),sender:"user",logo:(0,l.jsx)(i.g,{icon:o.X46}),name:"你",segments:[{type:t,content:r}],timestamp:new Date(d).toLocaleString()});else if(n||(n={id:"".concat(s,"-ai"),sender:"ai",logo:(0,l.jsx)(i.g,{icon:o.UBk}),name:"AI",segments:[],timestamp:new Date(d).toLocaleString()}),_.includes(t)){let e=n.segments.find(e=>e.id===c);e?e.content+=r:n.segments.push({type:t,id:c,content:r})}else n.segments.push({type:t,id:c,content:r})}),a&&t.push(a),n&&t.push(n)}m(t)},e=>{console.error("获取历史记录失败:",e)})}catch(e){console.error("处理历史记录失败:",e)}},E=async e=>{try{let s={id:"user-".concat(Date.now()),sender:"user",logo:(0,l.jsx)(i.g,{icon:o.X46}),name:"你",segments:[{type:"human",content:e}],timestamp:new Date().toLocaleString()};m([...g.current,s]);let r="";await N(t,e,(e,t)=>{let{block_type:s,content_id:a,content:n}=t;!S.includes(s)&&(f.current.push(t=>{let c=[...t],d=c.length-1,u=c[d];if(u&&u.id===e){let e=u.segments.length-1,t=u.segments[e];if(_.includes(s)){t&&t.id===a?r+=n:r=n;let l={type:s,id:a,content:r},i=[...u.segments];t&&t.id===a?i[e]=l:i.push(l);let o={...u,segments:i};c[d]=o}else{let e=[...u.segments,{type:s,id:a,content:n}],t={...u,segments:e};c[d]=t}}else c.push({id:e,sender:"ai",logo:(0,l.jsx)(i.g,{icon:o.UBk}),name:"AI",segments:[{type:s,id:a,content:n}],timestamp:new Date().toLocaleString()});return c}),b.current||(b.current=setInterval(()=>{if(f.current.length>0){let e=g.current;f.current.forEach(t=>{e=t(e)}),f.current=[],m(e)}else clearInterval(b.current),b.current=null},300)))},e=>{console.error("SSE 错误:",e)})}catch(e){console.error("发送消息失败:",e)}};return(0,l.jsxs)("div",{className:"flex flex-1 flex-col md:flex-row h-full",children:[a&&(0,l.jsx)("div",{className:"w-full md:w-1/4 h-full flex flex-col",children:(0,l.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,l.jsx)(x,{historyId:d,historyList:n,onSelectHistory:w,onNewHistory:v})})}),(0,l.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,l.jsx)("div",{className:"flex-1 overflow-y-auto p-4 h-full",children:(0,l.jsx)(p,{messages:h})}),(0,l.jsx)(y,{onSendMessage:E})]})]})}function E(e){let{agent:t,setAgent:s}=e;return(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto min-h-[150px] p-4",children:[(0,l.jsx)("h2",{children:"模型配置"}),(0,l.jsx)("form",{children:(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{children:(0,l.jsx)("label",{children:"智能体名称"})}),(0,l.jsx)("p",{children:(0,l.jsx)("label",{children:"从清单中选择模型"})}),(0,l.jsx)("p",{children:(0,l.jsx)("label",{children:"模型参数：温度、最大token数、种子等"})}),(0,l.jsx)("input",{type:"text",value:t,onChange:e=>s(e.target.value)})]})})]})}function I(){let{user:e,logout:t,fetchUser:s,refreshToken:i}=(0,a.A)(),[o,x]=(0,r.useState)(!0),[h,m]=(0,r.useState)(!1),[g,f]=(0,r.useState)("fake_llm"),[p,y]=(0,r.useState)("chat");return e?(0,l.jsxs)("div",{className:"p-5 pt-12 h-screen flex flex-col",children:[(0,l.jsx)(n.A,{username:e.username,onLogout:t,onFetchUser:s,onRefreshToken:i,currentPath:"/chat"}),(0,l.jsxs)("div",{className:"flex flex-1 flex-col md:flex-row h-full",children:[o?(0,l.jsx)(c,{onChangeAgent:f,selected_agent:g,setIsAgentListVisible:x,isAgentListVisible:o,setIsHistoryListVisible:m,isHistoryListVisible:h}):(0,l.jsx)(d,{agents:[{id:"fake_llm",name:"模拟",icon:"\uD83E\uDD16"},{id:"chat",name:"聊天",icon:"\uD83D\uDCAC"},{id:"learn",name:"训练",icon:"\uD83E\uDDD1‍\uD83C\uDF93"}],onChangeAgent:f,selected_agent:g,toggleAgentList:()=>x(!o),toggleHistoryList:()=>m(!h),isAgentListVisible:o,isHistoryListVisible:h}),(0,l.jsx)("div",{className:"flex-1 flex flex-col overflow-y-auto h-full",children:(0,l.jsx)(u,{tabs:[{key:"chat",label:"对话",content:(0,l.jsx)("div",{className:"flex-1 overflow-y-auto h-full",children:(0,l.jsx)(L,{agent:g,setAgent:f,isHistoryListVisible:h})})},{key:"settings",label:"配置",content:(0,l.jsx)("div",{className:"flex-1 overflow-y-auto h-full",children:(0,l.jsx)(E,{agent:g,setAgent:f})})}],selectedTab:p,onSelectTab:y})})]})]}):null}},4572:(e,t,s)=>{"use strict";s.d(t,{A:()=>i});var l=s(5155),r=s(2115),a=s(9757),n=s(5055);function i(e){let{content:t,getContent:s}=e,[i,o]=(0,r.useState)({show:!1,position:{x:0,y:0}}),[c,d]=(0,r.useState)(!1),u=async e=>{let l=t;if("function"==typeof s&&!t){d(!0);try{l=await s()}catch(e){console.error("获取复制内容失败:",e);return}finally{d(!1)}}navigator.clipboard.writeText(l).then(()=>{o({show:!0,position:{x:e.clientX,y:e.clientY}}),setTimeout(()=>o({show:!1,position:{x:0,y:0}}),500)}).catch(e=>{console.error("复制失败:",e)})};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{className:"ml-2 text-gray-400 hover:text-gray-600 focus:text-gray-800 transition-colors duration-200",onClick:u,title:"复制内容",disabled:c,children:(0,l.jsx)(a.g,{icon:c?n.z1G:n.jPR,className:c?"animate-spin":""})}),i.show&&(0,l.jsx)("div",{className:"absolute bg-green-500 text-white px-2 py-1 rounded shadow-lg",style:{top:i.position.y-30,left:i.position.x,zIndex:200},children:"复制成功"})]})}},5731:(e,t,s)=>{"use strict";s.d(t,{A:()=>i});var l=s(5155),r=s(7396),a=s(2115);function n(e){let{username:t,onLogout:s,onFetchUser:r,onRefreshToken:n}=e,[i,o]=(0,a.useState)(!1),c=(0,a.useRef)(null),d=t.length>10?"".concat(t.slice(0,10),"..."):t;return(0,a.useEffect)(()=>{let e=e=>{c.current&&!c.current.contains(e.target)&&o(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,l.jsxs)("div",{className:"relative",ref:c,children:[(0,l.jsx)("button",{onClick:()=>o(!i),className:"bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600",title:t,children:d}),i&&(0,l.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-50",children:[(0,l.jsx)("button",{onClick:r,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"魔法师信息"}),(0,l.jsx)("button",{onClick:n,className:"w-full text-left px-4 py-2 text-white hover:bg-gray-700",children:"更新魔法令牌"}),(0,l.jsx)("hr",{className:"border-gray-600"}),(0,l.jsx)("button",{onClick:s,className:"w-full text-left px-4 py-2 text-red-500 hover:bg-gray-700",children:"离开梦幻岛"})]})]})}function i(e){let{username:t,onLogout:s,onFetchUser:a,onRefreshToken:i,currentPath:o}=e;return(0,l.jsxs)("header",{className:"flex justify-between items-center fixed top-0 left-0 right-0 z-50 bg-gray-800 text-white p-2",children:[(0,l.jsx)("h1",{className:"text-xl md:text-2xl font-bold",children:"✨\uD83E\uDD8B 梦幻岛"}),(0,l.jsx)("div",{className:"flex space-x-4",children:["/publish","/chat","/knowledge","/agent"].map(e=>(0,l.jsx)(r.default,{href:e,children:(0,l.jsxs)("span",{className:"px-3 py-1 rounded-full transition-all duration-300 ".concat(o===e?"bg-gradient-to-r from-blue-400 to-purple-400 text-white shadow-md":"bg-transparent text-gray-200 hover:bg-gray-600"),children:["/publish"===e&&"传说","/knowledge"===e&&"秘典","/agent"===e&&"精灵","/chat"===e&&"魔语"]})},e))}),(0,l.jsx)("div",{className:"flex items-center",children:(0,l.jsx)(n,{username:t,onLogout:s,onFetchUser:a,onRefreshToken:i})})]})}},5012:(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var l=s(5155),r=s(2115),a=s(8050);function n(e){var t,s;let{isOpen:n,knowledge:i,get_knowledge:o,onClose:c}=e,[d,u]=(0,r.useState)(null),[x,h]=(0,r.useState)(!1),[m,g]=(0,r.useState)(null);return((0,r.useEffect)(()=>{(async()=>{if(n&&(null==i?void 0:i.id)&&!d){h(!0),g(null);try{let e=await o(i.id);u(e)}catch(e){console.error("加载数据失败:",e),g("加载失败，请重试")}finally{h(!1)}}})()},[n,null==i?void 0:i.id]),n)?(0,l.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&c()},children:(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-xl mx-4 my-6 w-full max-w-6xl h-[90vh] flex flex-col",children:[(0,l.jsx)("div",{className:"px-6 py-4 border-b",children:(0,l.jsxs)("div",{className:"flex justify-between items-start",children:[(0,l.jsx)("div",{className:"flex-1",children:(0,l.jsxs)("div",{className:"flex flex-col gap-2",children:[(null==i?void 0:null===(t=i.tags)||void 0===t?void 0:t.length)>0&&(0,l.jsx)("div",{className:"flex flex-wrap gap-2",children:i.tags.map((e,t)=>(0,l.jsx)("span",{className:"px-2 py-0.5 text-xs bg-blue-50 text-blue-600 rounded-full",children:e},t))}),(0,l.jsxs)("div",{className:"text-sm text-gray-500",children:[(0,l.jsxs)("div",{children:["ID: ",null==i?void 0:i.id]}),(null==i?void 0:i.source)&&(0,l.jsxs)("div",{children:["来源: ",i.source]})]})]})}),(0,l.jsx)("button",{className:"text-gray-500 hover:text-gray-700 transition-colors ml-4",onClick:c,children:(0,l.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),(0,l.jsx)("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:m?(0,l.jsx)("div",{className:"text-center text-red-500",children:m}):x?(0,l.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,l.jsx)("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"})}):(null==d?void 0:null===(s=d.content)||void 0===s?void 0:s.text)?(0,l.jsx)("div",{className:"prose prose-lg max-w-none",children:(0,l.jsx)(a.A,{content:d.content.text})}):(0,l.jsx)("div",{className:"text-center text-gray-500",children:"暂无内容"})}),(0,l.jsx)("div",{className:"px-6 py-3 border-t bg-gray-50",children:(0,l.jsx)("div",{className:"text-sm text-gray-500",children:(null==d?void 0:d.raw_meta)&&(0,l.jsxs)("details",{className:"mt-2",children:[(0,l.jsx)("summary",{className:"cursor-pointer hover:text-gray-700",children:"原始元数据"}),(0,l.jsx)("pre",{className:"mt-2 p-2 bg-gray-100 rounded text-xs overflow-x-auto",children:JSON.stringify(d.raw_meta,null,2)})]})})})]})}):null}},8050:(e,t,s)=>{"use strict";s.d(t,{A:()=>g});var l=s(5155);s(2115);var r=s(7564),a=s(7558),n=s(9054),i=s(7802),o=s(6731),c=s(7076),d=s(1883),u=s(8629),x=s(3273),h=s(4920);let m={...x.j,tagNames:[...x.j.tagNames,"question","final_answer","no_final_answer","context","knowledge","OUTLINE"],attributes:{...x.j.attributes,question:["className"],final_answer:["className"],no_final_answer:["className"],context:["className"],knowledge:["className"],OUTLINE:["className"]}};function g(e){let{content:t,className:s=""}=e,x=e=>{let{tagName:t,...s}=e;return(0,l.jsxs)("div",{className:"relative border border-blue-300 p-4 my-4 rounded-md bg-blue-50",children:[(0,l.jsx)("span",{className:"absolute top-0 left-2 bg-white px-2 text-xs text-blue-500 border border-blue-300 rounded -mt-2.5",children:t}),(0,l.jsx)("div",{...s})]})};return(0,l.jsx)("div",{className:"prose prose-sm max-w-none ".concat(s," bg-gray-100 p-2 rounded-lg shadow-md"),children:(0,l.jsx)(r.o,{remarkPlugins:[a.A,n.A,c.A,d.A],rehypePlugins:[u.A,(0,h.A)(m),i.A,o.A],components:{question:e=>(0,l.jsx)(x,{tagName:"question",...e}),final_answer:e=>(0,l.jsx)(x,{tagName:"final_answer",...e}),no_final_answer:e=>(0,l.jsx)(x,{tagName:"no_final_answer",...e}),context:e=>(0,l.jsx)(x,{tagName:"context",...e}),knowledge:e=>(0,l.jsx)(x,{tagName:"knowledge",...e}),OUTLINE:e=>(0,l.jsx)(x,{tagName:"OUTLINE",...e}),h1:e=>{let{node:t,...s}=e;return(0,l.jsx)("h1",{className:"text-3xl font-bold my-4",...s})},h2:e=>{let{node:t,...s}=e;return(0,l.jsx)("h2",{className:"text-2xl font-semibold my-3",...s})},p:e=>{let{node:t,...s}=e;return(0,l.jsx)("p",{className:"text-base leading-relaxed my-2",...s})},pre:e=>{let{node:t,...s}=e;return(0,l.jsx)("pre",{className:"bg-gray-800 text-white p-4 rounded-md my-4 overflow-x-auto",...s})}},children:t||""})})}},3201:(e,t,s)=>{"use strict";s.d(t,{A:()=>c,O:()=>o});var l=s(5155),r=s(6046),a=s(2115),n=s(2492);let i=(0,a.createContext)(),o=e=>{let{children:t}=e,[s,o]=(0,a.useState)(null),[c,d]=(0,a.useState)(!0),u=(0,r.useRouter)(),x=(0,r.usePathname)();(0,a.useEffect)(()=>{(async()=>{if("/login"===x){d(!1);return}try{let e=await (0,n.im)();e.username?o(e):u.push("/login")}catch(e){o(null),u.push("/login")}finally{d(!1)}})()},[x]);let h=async(e,t)=>{try{let s=await (0,n.iD)(e,t);return s&&o(s),s}catch(e){throw console.error("登录失败:",e),e}},m=async()=>{try{o(null),await (0,n.ri)()}catch(e){console.error("登出错误:",e)}u.push("/login")},g=async()=>{try{await (0,n.Be)()}catch(e){console.error("刷新令牌错误:",e)}},f=async()=>{try{let e=await (0,n.im)();o(e)}catch(e){console.error("获取用户信息错误:",e)}};return(0,l.jsx)(i.Provider,{value:{user:s,loading:c,login:h,logout:m,refreshToken:g,fetchUser:f},children:t})},c=()=>(0,a.useContext)(i)},5370:(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var l=s(2651),r=s(6828);let a=l.A.create({baseURL:r.J,withCredentials:!0});a.interceptors.response.use(e=>e,async e=>{let t=e.config;if(e.response&&401===e.response.status&&!t._retry){t._retry=!0;try{return await a.post("/api/auth/refresh-token",{},{withCredentials:!0}),a(t)}catch(e){return(0,r.t)(e),Promise.reject(e)}}return e.response&&403===e.response.status&&console.error("访问被拒绝:",e),(0,r.t)(e),Promise.reject(e)});let n=a},2492:(e,t,s)=>{"use strict";s.d(t,{Be:()=>i,iD:()=>r,im:()=>n,ri:()=>a});var l=s(5370);let r=async(e,t)=>{try{let s=new URLSearchParams;s.append("grant_type","password"),s.append("username",e),s.append("password",t);let r=await l.A.post("/api/auth/login",s,{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(!r.request.withCredentials)return alert("请检查浏览器隐私设置：客户端无法保存 Cookie 导致登录失败！"),null;return r.data}catch(e){throw console.error("登录失败:",e.response?e.response.data:e.message),Error("登录失败，请检查您的凭据并重试。")}},a=async()=>{try{await l.A.post("/api/auth/logout",{},{withCredentials:!0})}catch(e){if(e.response&&401===e.response.status)return;throw Error("登出失败")}},n=async()=>{try{return(await l.A.get("/api/auth/profile")).data}catch(e){console.log("获取用户信息失败")}},i=async()=>{try{await l.A.post("/api/auth/refresh-token",{},{withCredentials:!0})}catch(e){console.log("刷新令牌失败")}}},6828:(e,t,s)=>{"use strict";s.d(t,{J:()=>r,t:()=>a});var l=s(5521);let r="http://localhost:8001",a=e=>{e.response&&401===e.response.status?console.log("未授权，重定向到登录页"):console.log("API 请求错误:",e),l.default.push("/login")}}},e=>{var t=t=>e(e.s=t);e.O(0,[779,420,804,19,622,694,432,592,331,271,30,519,408,473,376,358],()=>t(7386)),_N_E=e.O()}]);